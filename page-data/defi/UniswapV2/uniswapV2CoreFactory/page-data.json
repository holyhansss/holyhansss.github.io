{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/defi/UniswapV2/uniswapV2CoreFactory/",
    "result": {"data":{"cur":{"id":"142fbebc-71eb-5d0e-ac35-d833fab2cf81","html":"<h1 id=\"-uniswap-v2-core-factory\" style=\"position:relative;\"><a href=\"#-uniswap-v2-core-factory\" aria-label=\" uniswap v2 core factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Uniswap V2 Core Factory</h1>\n<p>Uniswap V2는 Core와 Periphery로 나뉜다. Core은 Factory 와 Pair을 중심으로 이루어져 있으며 Core 말 그대로 Uniswap의 심장 역할을 한다. Periphery는 직역하면 주변부라는 뜻으로 실제 유저들이 상호작용을 하는 contract이다.</p>\n<p>오늘은 Uniswap V2 Factory contract 하나에 대해서 분석을 해볼 것이다!</p>\n<h2 id=\"uniswap-v2-factory-interface\" style=\"position:relative;\"><a href=\"#uniswap-v2-factory-interface\" aria-label=\"uniswap v2 factory interface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Factory Interface</h2>\n<p>우선 UniswapV2 Factory Contract의 Interface를 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">>=</span><span class=\"token version number\">0.5.0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">IUniswapV2Factory</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">PairCreated</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> token0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> token1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> pair<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">feeTo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">feeToSetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getPair</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">allPairs</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">allPairsLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">createPair</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">setFeeTo</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">setFeeToSetter</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>총 8개의 function과 1개의 event가 존재한다. 이름만 보며 각각의 기능들을 유추해보자!</p>\n<ul>\n<li>feeTo(): fee를 지불할 주소를 return한다.</li>\n<li>feeToSetter(): fee를 지불할 주소를 set한다.</li>\n<li>getPair(): tokenA와 tokenB의 pair 주소를 return한다.</li>\n<li>allPairs(): index를 받고 그에 해당하는 pair 주소를 return한다.</li>\n<li>allPairsLength(): pair 전체의 length를 return한다.</li>\n<li>createPair(): tokenA와 tokenB를 인자로 받아 pair을 생성한다. (가장 중요한 함수같다!)</li>\n<li>setFeeTo: feeTo함수를 설장하는 함수</li>\n<li>setFeeToSetter: setFeeTo()를 설정하는 함수</li>\n</ul>\n<p>간단하게는 감이 온것 같다! 이제 전체 코드를 보며 분석해보자!</p>\n<h2 id=\"uniswap-v2-factory-코드-분석\" style=\"position:relative;\"><a href=\"#uniswap-v2-factory-%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\" aria-label=\"uniswap v2 factory 코드 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Factory 코드 분석</h2>\n<h3 id=\"변수\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EC%88%98\" aria-label=\"변수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변수</h3>\n<p>우선 선언된 변수부터 살펴보자!</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> feeTo<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> feeToSetter<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">mapping</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> getPair<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">public</span> allPairs<span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>총 4개의 변수가 선언되었다.</p>\n<ul>\n<li>feeTo: fee를 받는 address이다.</li>\n<li>feeToSetter: feeTo의 address를 설정할 수 있는 address이다.</li>\n<li>getPair: 모든 token pair가 저장되어있는 mapping이다. ex) getPair[tokenA][tokenB] = A와 B의 pair주소</li>\n<li>allPairs: 모든 pair의 주소를 저장해놓는 배열이다.</li>\n</ul>\n<br>\n<h3 id=\"함수\" style=\"position:relative;\"><a href=\"#%ED%95%A8%EC%88%98\" aria-label=\"함수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>함수</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> _feeToSetter<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n        feeToSetter <span class=\"token operator\">=</span> _feeToSetter<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">allPairsLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> allPairs<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>우선 두가지의 함수를 보겠다. 첫번째로 constructor이다. constructor는 contract가 배포될 당시 딱 한번 실행되는 함수이다. constructor에서는 feeToSetter을 지정한다.\n두번째로 allPairsLength 함수이다. 이 함수는 함수 이름 그대로 allPairs의 길이를 가져오는 함수이다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token keyword\">function</span> <span class=\"token function\">createPair</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> pair<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Token A와 B의 address가 다른 것을 확인한다.</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>tokenA <span class=\"token operator\">!=</span> tokenB<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: IDENTICAL_ADDRESSES'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 주소의 값이 더 작은 것을 token0으로 지정하고 큰 주소를 token1로 지정한다.</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> token0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> token1<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> tokenA <span class=\"token operator\">&lt;</span> tokenB <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>tokenB<span class=\"token punctuation\">,</span> tokenA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// token0의 address가 zero address가 아닌 것을 확인한다.</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>token0 <span class=\"token operator\">!=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: ZERO_ADDRESS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// token0과 token1의 pair가 이미 존재하는지의 여부를 확인하다.</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>getPair<span class=\"token punctuation\">[</span>token0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>token1<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: PAIR_EXISTS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// single check is sufficient</span>\n        \n        <span class=\"token comment\">// contract creation bytecode를 불러온다.</span>\n        <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">memory</span> bytecode <span class=\"token operator\">=</span> <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>UniswapV2Pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>creationCode<span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// token0와 token1의 주소의 hash값을 salt라는 변수에 저장한다.</span>\n        <span class=\"token builtin\">bytes32</span> salt <span class=\"token operator\">=</span> <span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span>abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodePacked</span><span class=\"token punctuation\">(</span>token0<span class=\"token punctuation\">,</span> token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// opcode create2를 사용해 contract를 생성한다.</span>\n        <span class=\"token keyword\">assembly</span> <span class=\"token punctuation\">{</span>\n            pair <span class=\"token operator\">:=</span> <span class=\"token function\">create2</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>bytecode<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">mload</span><span class=\"token punctuation\">(</span>bytecode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> salt<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 생성된 pair contract를 initialize한다.</span>\n        <span class=\"token function\">IUniswapV2Pair</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>token0<span class=\"token punctuation\">,</span> token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// getPair mapping에 pair의 주소 값을 대입한다.</span>\n        getPair<span class=\"token punctuation\">[</span>token0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>token1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> pair<span class=\"token punctuation\">;</span>\n        getPair<span class=\"token punctuation\">[</span>token1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>token0<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> pair<span class=\"token punctuation\">;</span> <span class=\"token comment\">// populate mapping in the reverse direction</span>\n        \n        <span class=\"token comment\">// allPairs에 pair 주소를 추가한다.</span>\n        allPairs<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">PairCreated</span><span class=\"token punctuation\">(</span>token0<span class=\"token punctuation\">,</span> token1<span class=\"token punctuation\">,</span> pair<span class=\"token punctuation\">,</span> allPairs<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>createPair은 Factory Contract의 가장 중요한 함수라고 생각한다!\n간단한 분석은 코드 자체에 주석으로 남겨두었다.</p>\n<p>여기서 나는 create2라는 opcode를 처음 접했다. create과 똑같이 contract를 생성하지만 create2는 nonce값이 빠져있다고 한다.\n우선 <code class=\"language-text\">type(UniswapV2Pair).creationCode</code> 라는 부분에서 처음 막혔다. type이 뭔가~ 하고 <a href=\"https://docs.soliditylang.org/en/v0.8.10/units-and-global-variables.html?highlight=type#type-information\">solidity docs</a>를 찾아 보았다.</p>\n<blockquote>\n<p>type(C).creationCode: Memory byte array that contains the creation bytecode of the contract. This can be used in inline assembly to build custom creation routines, especially by using the create2 opcode. This property can not be accessed in the contract itself or any derived contract. It causes the bytecode to be included in the bytecode of the call site and thus circular references like that are not possible.</p>\n</blockquote>\n<p>간단하게 설명하면 assembly를 활용해 커스텀으로 contract를 생성할 수 있는 것이다. 그리고 특히 create2 opcode를 사용할 때 <code class=\"language-text\">type(C).creationCode</code>를 활용 할 수 있다.</p>\n<p>create2라는 opcode를 활용하면 만들어진 contract의 주소값을 얻을 수 있고, 이를 바로 활용하여 <code class=\"language-text\">initialize</code> 할 수 있다.</p>\n<h2 id=\"번외\" style=\"position:relative;\"><a href=\"#%EB%B2%88%EC%99%B8\" aria-label=\"번외 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>번외</h2>\n<p>그리고 create2를 찾아보던 중 신기한 것을 발견했다. create2는 create와 다르게 nonce 값이 빠져있기 떄문에 주소를 예측할 수 있다.\n즉 createPair()에서 들어가는 token0와 token1의 주소를 안다면 contract의 주소를 예측 할 수 있는 것이다.</p>\n<p>그리고 만약 token0와 token1의 pair contarct에 selfdesturct 정의 되어있고, 이가 실행된다면 contract는 삭제될 것이다. 하지만 우리는 token0와 token1의 주소를 알기 때문에 삭제된 contract의 주소와 같은 주소로 contract를 배포할 수도 있다.</p>\n<p>하지만 다행히 contract가 이미 존재하고 selfdesturct가 불리지 않는다면 contract 주소를 뺏어오는 것은 불가능하다.</p>\n<p>create2는 몇가지 취약점을 가지고 있기 때문에 확실히 알고 쓰지 않는다면 위험 할수도 있다. <del>(다음엔 create2 취약점에 대해서 다루어보자!)</del></p>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>시험기간이라 그런지 학교 공부는 집중이 잘 안되서 분석을 해보았다!ㅋㅋㅋ assembly는 아직 익숙하지 않아서인지 완전히 이해하기까지 시간이 걸렸다. <del>아직 갈길이 멀다는 것ㅜㅜ</del> 다음 분석은 Pair contract를 해보도록 하겠다!</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#uniswap-v2-factory-interface\">Uniswap V2 Factory Interface</a></p>\n</li>\n<li>\n<p><a href=\"#uniswap-v2-factory-%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\">Uniswap V2 Factory 코드 분석</a></p>\n<ul>\n<li><a href=\"#%EB%B3%80%EC%88%98\">변수</a></li>\n<li><a href=\"#%ED%95%A8%EC%88%98\">함수</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%B2%88%EC%99%B8\">번외</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></p>\n</li>\n</ul>\n</div>","excerpt":"👋 Uniswap V2 Core Factory Uniswap V2는 Core와 Periphery로 나뉜다. Core은 Factory 와 Pair을 중심으로 이루어져 있으며 Core 말 그대로 Uniswap의 심장 역할을 한다. Periphery는 직역하면 주변부라는 뜻으로 실제 유저들이 상호작용을 하는 contract이다. 오늘은 Uniswap V2 Factory contract 하나에 대해서 분석을 해볼 것이다! Uniswap V2 Factory Interface 우선 UniswapV2 Factory Contract의 Interface를 보자. 총 8개의 function과 1개의 event가 존재한다. 이름만 보며 각각의 기능들을 유추해보자! feeTo(): fee를 지불할 주소를 return한다. feeToSetter(): fee를 지불할 주소를 set한다. getPair(): tokenA와 tokenB의 pair 주소를 return한다. allPairs(): index를 받고…","frontmatter":{"date":"April 19, 2022","title":"Uniswap V2 Core Factory Contract 분석","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/UniswapV2/uniswapV2CoreFactory/"}},"next":{"id":"6004aea0-10c9-582c-a907-40cb1006a5ea","html":"<h1 id=\"-eip-2981에-대하여-royalty-standard---재판매-수수료\" style=\"position:relative;\"><a href=\"#-eip-2981%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC-royalty-standard---%EC%9E%AC%ED%8C%90%EB%A7%A4-%EC%88%98%EC%88%98%EB%A3%8C\" aria-label=\" eip 2981에 대하여 royalty standard   재판매 수수료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 EIP-2981에 대하여 (Royalty Standard) -> 재판매 수수료</h1>\n<h2 id=\"무엇이며-왜-등장하였나\" style=\"position:relative;\"><a href=\"#%EB%AC%B4%EC%97%87%EC%9D%B4%EB%A9%B0-%EC%99%9C-%EB%93%B1%EC%9E%A5%ED%95%98%EC%98%80%EB%82%98\" aria-label=\"무엇이며 왜 등장하였나 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>무엇이며 왜 등장하였나?</h2>\n<p>EIP-2981은 NFT(Non-Furgable Token)에 대한 Royalty(재판매 수수료) 지급 정보를 저장해두는 표준이다.</p>\n<p>현재 NFT의 Royalty 좀 이상하다. 진짜 말 그대로 이상하다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABJ0AAASdAHeZh94AAABt0lEQVQoz4VRZ2/iQBD1//9biA8ICDUkuBtwy9pxY826rN9p1odzkZBu7KcpmnlTVpNSQsoBwzCAhOyn/wqg/69+Be1yS6GbMT71CIYV4+p/4+McwrQZjh8+LJepBiQTqar9+f4VrZcSbdujaToI0aHrJIRoJ5/0uIWcisgenlvI35Nrv+gHoG1aVGWFmnPlN6JRuN85kiRBkRd4JUSsVv5p+yRsUPManNfo2k41oGR+5/B9H7quI/AD+Dcf7Ivhdr2hLMqJVHs8HiCQ5HkBy3ZH/k4iyzLYjjfdr65r5FmuUBQFqqpCnudTvVo5TVMQZC8RxV84Gxb6oQNvOFiS4lM3p8OXZanWjuMYjDGlCVTf9/34KEIINM14J7pdkqTIqgznUIeo7si+M1COeAilPc/DarWC67oKl8sFtu0om3MOjTpSt4QliKMYtmUgigLEYYTosAMLQyQsVfeinNPphNlsBtM0J1LLssbbBgE0CjiOA9dxYRgG3k/vcL1nbIw7tgPP9XA8HrFYLLBer9WU8/kcy+US18tVTUpcGiUpHP6P/W6P7WaL3Xan9Nv6DZvNBof9QYFy/gBDP0Bp4JJUOQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Royalty_System\"\n        title=\"Royalty_System\"\n        src=\"/static/dbe4c33284caa1f7b56906c9d23a46e3/37523/Royalty_System.png\"\n        srcset=\"/static/dbe4c33284caa1f7b56906c9d23a46e3/e9ff0/Royalty_System.png 180w,\n/static/dbe4c33284caa1f7b56906c9d23a46e3/f21e7/Royalty_System.png 360w,\n/static/dbe4c33284caa1f7b56906c9d23a46e3/37523/Royalty_System.png 720w,\n/static/dbe4c33284caa1f7b56906c9d23a46e3/8c857/Royalty_System.png 761w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n위 사진을 보면 알 수 있다시피, marketplace마다 royalty 지급 기준이 다르다. 그러면 다음과 같은 문제가 일어날 수 있다.\n<p>예를 들에 OpenSea에서 A가 작품을 민팅하여 판다고 가정해보자. 그리고 10%의 royalty를 적용했다고 생각해보자.</p>\n<ol>\n<li>A는 Opensea를 사용해 B에게 작품 판매를 통해 돈을 벌었다.</li>\n<li>B는 Opensea에서 다시 작품을 C 판매해 수익의 90%를 챙긴고, 10%는 A에게 돌아간다.</li>\n<li>C는 Opensea가 아닌 Rarible에가서 작품을 재판매 했다.</li>\n<li>C는 돈을 받지만 A는 작품에 대한 Royalty를 받지 못한다.</li>\n</ol>\n<p>현재 대부분의 marketplace는 Royalty에 대해서 호환되지 않는다.\n이 부분을 보안하기 위해서 EIP-2981이 등장하게 되었다.</p>\n<br>\n<br>\n<h2 id=\"저장수장이라고\" style=\"position:relative;\"><a href=\"#%EC%A0%80%EC%9E%A5%EC%88%98%EC%9E%A5%EC%9D%B4%EB%9D%BC%EA%B3%A0\" aria-label=\"저장수장이라고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>저장수장이라고?</h2>\n<p>그렇다 EIP-2981은 Royalty의 정보를 저장해 놓는 방법을 말한다.</p>\n<p>그렇다면 왜 MarketPlace는 왜 royalty standard를 사용할까?</p>\n<ul>\n<li>Royalty Standard를 사용하게 된다면 플랫폼간의 호환성이 생긴다. 이는 원작자를 보호할 수 있는 하나의 수단이 되며, 더 많은 사용자를 끌어들일 수 있을 것이다.</li>\n</ul>\n<br>\n<br>\n<h2 id=\"opensea는-어떻게-하고-있는가\" style=\"position:relative;\"><a href=\"#opensea%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EA%B3%A0-%EC%9E%88%EB%8A%94%EA%B0%80\" aria-label=\"opensea는 어떻게 하고 있는가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Opensea는 어떻게 하고 있는가?</h2>\n<p>현재는 각자의 플랫폼 마다 royalty를 적용하는 방법이 다르다. Opensea와 같은 경우는 smart contract에 contractURI를 정의해놓는 것으로 json파일의 링크를 넣는다. 그리고 json 파일은 collection의 이름, 설명, 메인 이미지, Royalty Info 등을 가진다.</p>\n<br>\n<br>\n<h2 id=\"marketplace는-지금-royalty-standard를-적용하였나\" style=\"position:relative;\"><a href=\"#marketplace%EB%8A%94-%EC%A7%80%EA%B8%88-royalty-standard%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%98%EC%98%80%EB%82%98\" aria-label=\"marketplace는 지금 royalty standard를 적용하였나 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Marketplace는 지금 royalty standard를 적용하였나?</h2>\n<p>테스트를 진행해본 결과 아직 적용이 되지는 않았다. 하지마 몇달 내에 적용 될 것으로 보인다</p>\n<hr>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#%EB%AC%B4%EC%97%87%EC%9D%B4%EB%A9%B0-%EC%99%9C-%EB%93%B1%EC%9E%A5%ED%95%98%EC%98%80%EB%82%98\">무엇이며 왜 등장하였나?</a></li>\n<li><a href=\"#%EC%A0%80%EC%9E%A5%EC%88%98%EC%9E%A5%EC%9D%B4%EB%9D%BC%EA%B3%A0\">저장수장이라고?</a></li>\n<li><a href=\"#opensea%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EA%B3%A0-%EC%9E%88%EB%8A%94%EA%B0%80\">Opensea는 어떻게 하고 있는가?</a></li>\n<li><a href=\"#marketplace%EB%8A%94-%EC%A7%80%EA%B8%88-royalty-standard%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%98%EC%98%80%EB%82%98\">Marketplace는 지금 royalty standard를 적용하였나?</a></li>\n</ul>\n</div>","frontmatter":{"date":"March 29, 2022","title":"EIP-2981에 대하여 (Royalty Standard)","categories":"NFT","author":"한성원","emoji":"🧢"},"fields":{"slug":"/NFT/EIP-2981에대하여/EIP-2981에대하여/"}},"prev":{"id":"596e2b2f-dd97-5a45-8f4f-b023a520d5f3","html":"<h1 id=\"-uniswap-v2-core-pair\" style=\"position:relative;\"><a href=\"#-uniswap-v2-core-pair\" aria-label=\" uniswap v2 core pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Uniswap V2 Core Pair</h1>\n<p>저번주에 <a href=\"https://holyhansss.github.io/defi/uniswapV2CoreFactory/\">Uniswap Factory Contract</a> 분석을 해봤다. Factory는 생각보다는 코드가 쉬웠지만 Pair은 조금 더 어려워 보인다!</p>\n<p>Pair Contact는 <a href=\"https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol\">여기서</a> 확인할 수 있고 Pair 분석 전 <a href=\"https://holyhansss.github.io/defi/uniswapV2CoreFactory/\">Factory Contract 분석</a>을 보고오면 좋을 것 같다.</p>\n<h2 id=\"uniswap-v2-pair-interface\" style=\"position:relative;\"><a href=\"#uniswap-v2-pair-interface\" aria-label=\"uniswap v2 pair interface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Pair Interface</h2>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">IUniswapV2Pair</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Approval</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> owner<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> spender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Transfer</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">decimals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">totalSupply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">allowance</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> spender<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">approve</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> spender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">DOMAIN_SEPARATOR</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">PERMIT_TYPEHASH</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">nonces</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">permit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> spender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> deadline<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint8</span> v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes32</span> r<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes32</span> s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount0In<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount1In<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount0Out<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount1Out<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> to\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Sync</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">MINIMUM_LIQUIDITY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">factory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">token0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">token1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> reserve1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint32</span> blockTimestampLast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">price0CumulativeLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">price1CumulativeLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">kLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">calldata</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">skim</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>이 Interface에는 UniswapERC20 token의 interface도 포함되어 있는 것으로 보인다.\n실제 repository를 확인해 보면 UniswapERC20 token의 Interface도 따로 존재한다.\nPair contract는 Factory contract를 통해 pool 별로 배포된다. 그리고 그 안에서 swap이 일어나는 것으로 보인다.\n직접 코드를 더 봐야할 것 같지만 Uniswap이라는 이름에서 알 수 있듯이 <code class=\"language-text\">swap</code> 이라는 함수가 이 contract에서 가장 중요해 보인다. <code class=\"language-text\">swap</code>을 중심으로 Pair 코드를 뜯어보며 알아보자!</p>\n<h2 id=\"uniswap-v2-factory-코드-분석\" style=\"position:relative;\"><a href=\"#uniswap-v2-factory-%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\" aria-label=\"uniswap v2 factory 코드 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Factory 코드 분석</h2>\n<p>github에서 확인해보면 코드는 200 줄이 넘기 때문에 주석을 통해 간단한 활용성을 남기고, 중요한 함수는 코드 뒤에 따로 다루도록 할 것이다.</p>\n<h3 id=\"변수\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EC%88%98\" aria-label=\"변수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변수</h3>\n<p>우선 선언된 변수부터 살펴보자. 변수 선언부터 배울 것이 상당하다!\n<br></p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// uint에 SafeMath 적용</span>\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">SafeMath</span>  <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// uint224에 UQ112x112 적용 (UQ112는 분수 계산을 할때 쓰인다. 나중에 Library를 확인해 보자!)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">UQ112x112</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint224</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// liquidity의 최솟값을 10**3으로 정의</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> MINIMUM_LIQUIDITY <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token operator\">**</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// transfer의 Method ID를 SELECTOR 변수에 설정</span>\n    <span class=\"token builtin\">bytes4</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">constant</span> SELECTOR <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes4</span><span class=\"token punctuation\">(</span><span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transfer(address,uint256)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// factory contract의 address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> factory<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// token0의 address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> token0<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// token1의 address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> token1<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// reserve0, reserve1, blockTimestampLast가 하나의 storage slot에 선언되어있다.</span>\n    <span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve0<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n    <span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve1<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n    <span class=\"token builtin\">uint32</span>  <span class=\"token keyword\">private</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> price0CumulativeLast<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> price1CumulativeLast<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> kLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 * reserve1, as of immediately after the most recent liquidity event</span>\n\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">private</span> unlocked <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>너무 많은 변수가 선언되어 있기 때문에 중요하게 생각되는 부분만 설명을 할 것이다.</p>\n<ol>\n<li>우선 눈에 띄는 것은 <code class=\"language-text\">using UQ112x112 for uint224</code> 였다. library를 확인해보니 overflow를 방지 및 분수 계산을 하기 위해 만들어진 library로 보인다.</li>\n<li>두번째로 <code class=\"language-text\">reserve0</code> <code class=\"language-text\">reserve1</code> <code class=\"language-text\">blockTimestampLast</code>를 하나의 storage slot에 넣어둔 것이다.\n<ul>\n<li>여기서 reserve0와 reserve1은 uint112, blockTimestampLast는 uint32로 선언되어있다. storage는 한 slot당 256 bits(32 bytes)임으로 세 변수를 모두 하나의 slot에 넣을 수 있다. 이것은 gas를 save하기 위한 것으로 보인다.</li>\n<li>뇌피셜이지만 storage를 불러올때 gas가 사용되는데, 여러 slot에 나누어 저장하면 slot마다 gas를 더 지불해야한다. 그래서 하나의 slot에 저장해 한번에 불러올 수 있게 한 것도 gas가격을 줄이기 위한 하나의 방법인 것 같다.</li>\n</ul>\n</li>\n<li>MINIMUM_LIQUIDITY: 절대 0으로 division 되는 경우를 막기위해 최소 Liquidity를 지정했다</li>\n</ol>\n<p>나머지 변수는 주요 코드를 분석하면서 보도록하자!</p>\n<br>\n<h3 id=\"함수\" style=\"position:relative;\"><a href=\"#%ED%95%A8%EC%88%98\" aria-label=\"함수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>함수</h3>\n<p>주요 함수를 설명하면서 세부적으로 call되는 함께 설명할 예정이다.\n주요 함수는 <code class=\"language-text\">mint</code>, <code class=\"language-text\">burn</code>, <code class=\"language-text\">swap</code> 그 외 함수는 이 함수들을 위해 존재한다고 볼 수 있다.</p>\n<h4 id=\"mint\" style=\"position:relative;\"><a href=\"#mint\" aria-label=\"mint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>mint</h4>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// getReserves()를 통해 reserve0과 reserve1을 가져온다.</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n    <span class=\"token comment\">// contract에 있는 token의 balance를 불러온다.</span>\n    <span class=\"token builtin\">uint</span> balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// amount 값을 각 token balance - reserve 로 계산한다.</span>\n    <span class=\"token builtin\">uint</span> amount0 <span class=\"token operator\">=</span> balance0<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> amount1 <span class=\"token operator\">=</span> balance1<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// feeOn을 통해 fee의 여부를 가져온다.</span>\n    <span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> _totalSupply <span class=\"token operator\">=</span> totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings, must be defined here since totalSupply can update in _mintFee</span>\n    <span class=\"token comment\">// 첫번째 당시 totalSupply가 0일때 최소 totalsupply 값을 10**3으로 설정한다. -> 맨 처음 한번밖에 실행 안됨</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_totalSupply <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        liquidity <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>amount0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>MINIMUM_LIQUIDITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// lp token 10**3개 만큼 mint</span>\n       <span class=\"token function\">_mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MINIMUM_LIQUIDITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// permanently lock the first MINIMUM_LIQUIDITY tokens</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// min 값으로 liquidity 설정</span>\n        liquidity <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>amount0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_totalSupply<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _reserve0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_totalSupply<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// liquidity값이 0보다 큰지 확인</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>liquidity <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// liquidity 값 만큼 address to에 mint를 진행한다.</span>\n    <span class=\"token function\">_mint</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// reserve 값 update</span>\n    <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span>\n    <span class=\"token keyword\">emit</span> <span class=\"token function\">Mint</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>mint 함수는 LP token을 mint 해주는 함수이다. 즉, periphery contract를 통해 유동성 풀에 유동성을 공급할때 호출된다. getRerserve()를 통해 두 reserve값을 받아온다.</p>\n<p>mint에는 두가지 경우가 존재한다.</p>\n<ol>\n<li><code class=\"language-text\">totalSupply</code>가 0을때</li>\n<li><code class=\"language-text\">totalSupply</code>가 0이 아닐때</li>\n</ol>\n<p><code class=\"language-text\">totalSupply</code>가 0이라면 liquidity값을 임의로 구하고, 1000개의 토큰을 zero address에 mint한다. 우선 임의로 liquidity 값을 임의로 구하는 이유는 처음에 두 토큰의 상대적인 가치를 알지 못하기 때문이라고 docs에 써있었다.</p>\n<p>1000개의 token을 zero address에 mint하는 이유는 zero division을 막기 위해서이다. zero address가 소유하고 있다면 token을 lock할 수 있다.</p>\n<p><code class=\"language-text\">totalSupply</code>가 0이 아니라면, 즉 위 if 문이 이미 실행 되었다면 liquidity의 값을 다른 방식으로 계산한다. 이때, 우리는 토큰간의 exchange rate을 알고 있기 때문에, 유동성 제공자가 동일한 가치의 토큰을 예치할 수 있도록 한다.</p>\n<p><code class=\"language-text\">liquidity</code>의 계산 값이 0보다 크다면 <code class=\"language-text\">to</code>에게 LP 토큰을 발행한다. 이후 <code class=\"language-text\">_update()</code>을 통해 reserve0과 reserve1의 값을 업데이트한다.\n<br></p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// update reserves and, on the first call per block, price accumulators</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> balance0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> balance1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>balance0 <span class=\"token operator\">&lt;=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> balance1 <span class=\"token operator\">&lt;=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: OVERFLOW'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint32</span> blockTimestamp <span class=\"token operator\">=</span> <span class=\"token builtin\">uint32</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>timestamp <span class=\"token operator\">%</span> <span class=\"token number\">2</span><span class=\"token operator\">**</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint32</span> timeElapsed <span class=\"token operator\">=</span> blockTimestamp <span class=\"token operator\">-</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// overflow is desired</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeElapsed <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> _reserve0 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> _reserve1 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// * never overflows, and + overflow is desired</span>\n            price0CumulativeLast <span class=\"token operator\">+=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>UQ112x112<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uqdiv</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> timeElapsed<span class=\"token punctuation\">;</span>\n            price1CumulativeLast <span class=\"token operator\">+=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>UQ112x112<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uqdiv</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> timeElapsed<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        reserve0 <span class=\"token operator\">=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        reserve1 <span class=\"token operator\">=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span>balance1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        blockTimestampLast <span class=\"token operator\">=</span> blockTimestamp<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Sync</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">,</span> reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">_update()</code>는 토큰이 deposit 되거나 withdraw 될 때 불리는 internal 함수이다. require문을 통해 balance들의 overflow를 체크한다. 그리고 <code class=\"language-text\">reserve</code>의 값들과 <code class=\"language-text\">blockTimestampLast</code>값을 새로운 값으로 update 해준다.</p>\n<p>여기서 생기는 궁금증이 있다. <code class=\"language-text\">price0CumulativeLast</code> 값은 도대체 어디에 쓰이는지 모르겠다. Defi Math를 공부하면서 TWAP(Time weighted average price)에 대해서 배웠고, <code class=\"language-text\">price0CumulativeLast</code>와 <code class=\"language-text\">price1CumulativeLast</code> 값에 적용된 것도 확인할 수 있었다. 하지만 코드에서는 <code class=\"language-text\">price0CumulativeLast</code>와 <code class=\"language-text\">price1CumulativeLast</code>를 사용하는 곳을 찾을 수 없어 의아했다. (Defi math도 다른 포스트에서 다룰 예정입니당)</p>\n<p>아마도 다른 곳에서 uniswap pair안의 토큰 가격을 Oracle로 제공하기 위해서 인것 같다. 나중에 다른 코드들을 보다면 사용성을 확인 할 수 있을 것으로 보인다. 아마 front-end에서도 사용될 수도 있을 것 같다.</p>\n<blockquote>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles\">UniswapV2 docs</a>를 찾아보니 oracle을 위해 만들어진 것이 맞다!ㅎㅎ Defi oracle 관련해서 문제가 많았지만 UniswapV2에서 약간이나마 해결한 것으로 보인다.</p>\n</blockquote>\n<h4 id=\"burn\" style=\"position:relative;\"><a href=\"#burn\" aria-label=\"burn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>burn</h4>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token keyword\">function</span> <span class=\"token function\">burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n        <span class=\"token builtin\">address</span> _token0 <span class=\"token operator\">=</span> token0<span class=\"token punctuation\">;</span>                                <span class=\"token comment\">// gas savings</span>\n        <span class=\"token builtin\">address</span> _token1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">;</span>                                <span class=\"token comment\">// gas savings</span>\n        <span class=\"token builtin\">uint</span> balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> liquidity <span class=\"token operator\">=</span> balanceOf<span class=\"token punctuation\">[</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> _totalSupply <span class=\"token operator\">=</span> totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings, must be defined here since totalSupply can update in _mintFee</span>\n        amount0 <span class=\"token operator\">=</span> liquidity<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// using balances ensures pro-rata distribution</span>\n        amount1 <span class=\"token operator\">=</span> liquidity<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance1<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// using balances ensures pro-rata distribution</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0 <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> amount1 <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">_burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Burn</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">burn()</code>은 liquidity를 해지(withdraw) 할때 사용되는 function이다. burn은 periphery contract을 통해 호출된다. 이때, pro-rata distribution을 사용해 address에 돌려줄 값을 구한다. (liquidity * balance / totalSupply로 계산한다.) 만약 amount의 값이 모두 0보다 크다면 amount만큼의 token을 이체한다. 이후 liquidity도 burn한다. 그리고 reserve값을 update해준다.</p>\n<p>이때 보면 <code class=\"language-text\">// gas saving</code> 이라는 주석을 많이 볼 수 있었다. 계산을 할때 storage val을 여러번 사용해야 하는데 만약 계속 storage val 사용하면 gas fee가 올라간다. 그래서 storage val을 local val에 저장해 local val을 계속해서 사용하도록 한것이다.</p>\n<h4 id=\"swap\" style=\"position:relative;\"><a href=\"#swap\" aria-label=\"swap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>swap</h4>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// this low-level function should be called from a contract which performs important safety checks</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">calldata</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0Out <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> amount1Out <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0Out <span class=\"token operator\">&lt;</span> _reserve0 <span class=\"token operator\">&amp;&amp;</span> amount1Out <span class=\"token operator\">&lt;</span> _reserve1<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint</span> balance0<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> balance1<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token comment\">// scope for _token{0,1}, avoids stack too deep errors</span>\n        <span class=\"token builtin\">address</span> _token0 <span class=\"token operator\">=</span> token0<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">address</span> _token1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>to <span class=\"token operator\">!=</span> _token0 <span class=\"token operator\">&amp;&amp;</span> to <span class=\"token operator\">!=</span> _token1<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INVALID_TO'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amount0Out <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount0Out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// optimistically transfer tokens</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amount1Out <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount1Out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// optimistically transfer tokens</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">IUniswapV2Callee</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uniswapV2Call</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0Out<span class=\"token punctuation\">,</span> amount1Out<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token builtin\">uint</span> amount0In <span class=\"token operator\">=</span> balance0 <span class=\"token operator\">></span> _reserve0 <span class=\"token operator\">-</span> amount0Out <span class=\"token operator\">?</span> balance0 <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>_reserve0 <span class=\"token operator\">-</span> amount0Out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> amount1In <span class=\"token operator\">=</span> balance1 <span class=\"token operator\">></span> _reserve1 <span class=\"token operator\">-</span> amount1Out <span class=\"token operator\">?</span> balance1 <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>_reserve1 <span class=\"token operator\">-</span> amount1Out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0In <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> amount1In <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_INPUT_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token comment\">// scope for reserve{0,1} Adjusted, avoids stack too deep errors</span>\n        <span class=\"token builtin\">uint</span> balance0Adjusted <span class=\"token operator\">=</span> balance0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>amount0In<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> balance1Adjusted <span class=\"token operator\">=</span> balance1<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>amount1In<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>balance0Adjusted<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance1Adjusted<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token operator\">**</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: K'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0In<span class=\"token punctuation\">,</span> amount1In<span class=\"token punctuation\">,</span> amount0Out<span class=\"token punctuation\">,</span> amount1Out<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">swap()</code>도 periphery contract를 통해 호출된다.</p>\n<ol>\n<li>output의 값이 0보다 큰지 확인한다.</li>\n<li>reserve의 값보다 amountOut의 값이 작은지 확인한다. &#x3C; 당연히 token 보유량보다 amountOut의 값이 적어야한다.</li>\n<li>to의 값이 token0, 또는 token1의 주소 값이 아닌 것을 확인한다.</li>\n<li>amountOut의 값만큼 to에게 송금한다.</li>\n<li>이후 들어온 토큰의 개수를 사용해 amountIn의 값을 계산한다.</li>\n<li>balance의 값을 다시 구한한다.</li>\n<li>adjust된 balance의 값과 reserve의 값의 값과 비교한다.</li>\n<li>reserve의 값을 update한다.</li>\n</ol>\n<p>내가 여기서 궁금했던 점은 swap은 하나의 토큰을 다른 토큰으로 교환하는 것인데, 두 token에 <code class=\"language-text\">_safeTransfer</code>을 사용하는지 였다. 궁금증을 해소하기 위해 잠시 periphery contract를 확인해 보았다. periphery contract에서 <code class=\"language-text\">swap()</code>를 call할 때는 둘중의 하나의 값이 무조껀 0이 되게 만들어 놓았다. 이 부분은 periphery contract을 살펴볼때 더 자세히 들여다보자!</p>\n<p>amountIn의 값을 구할때는 현재 token balance와 설정된 reserve값 + amountOut값을 비교해 amountIn의 값을 구한다.</p>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>나름대로 분석을 진행해봤지만 아직 부족한 점이 많은 것 같다고 느낀다. 더 많은 defi contract를 분석하다보면 전체적인 구조 및 코드가 작성된 이유를 파악하는데 도움이 될 것 같다. 그리고 이번글은 구조적으로 조금 부족한 것 같아 더 구조가 잡혀있는 글을 쓰기위해 노력 할 것이다. 다음으로는 periphery contract와 UniswapV2 Defi Math에 대해서 다룰 예정이다. Defi를 공부하는 모두 화이팅!</p>\n<h2 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h2>\n<ul>\n<li><a href=\"https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external\">https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external</a></li>\n<li><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps\">https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps</a></li>\n<li><a href=\"https://boohyunsik.tistory.com/9?category=922110\">https://boohyunsik.tistory.com/9?category=922110</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#uniswap-v2-pair-interface\">Uniswap V2 Pair Interface</a></p>\n</li>\n<li>\n<p><a href=\"#uniswap-v2-factory-%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\">Uniswap V2 Factory 코드 분석</a></p>\n<ul>\n<li>\n<p><a href=\"#%EB%B3%80%EC%88%98\">변수</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%95%A8%EC%88%98\">함수</a></p>\n<ul>\n<li><a href=\"#mint\">mint</a></li>\n<li><a href=\"#burn\">burn</a></li>\n<li><a href=\"#swap\">swap</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></p>\n</li>\n<li>\n<p><a href=\"#ref\">Ref</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"April 27, 2022","title":"Uniswap V2 Core Pair Contract 분석","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/UniswapV2/uniswapV2CorePair/"}},"site":{"siteMetadata":{"siteUrl":"https://holyhansss.github.io","comments":{"utterances":{"repo":"holyhansss/holyhansss.github.io"}}}}},"pageContext":{"slug":"/defi/UniswapV2/uniswapV2CoreFactory/","nextSlug":"/NFT/EIP-2981에대하여/EIP-2981에대하여/","prevSlug":"/defi/UniswapV2/uniswapV2CorePair/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}