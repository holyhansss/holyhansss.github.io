{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/defi/UniswapV2/uniswapV2PeripheryRouter/",
    "result": {"data":{"cur":{"id":"46407ff2-61e2-5f35-952b-fb4a6ed61162","html":"<h1 id=\"-uniswap-v2-periphery-router\" style=\"position:relative;\"><a href=\"#-uniswap-v2-periphery-router\" aria-label=\" uniswap v2 periphery router permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Uniswap V2 Periphery Router</h1>\n<p>Uniswap V2 Periphery Router에는 <code class=\"language-text\">UniswapV2Router01.sol</code>와 <code class=\"language-text\">UniswapV2Router02.sol</code>, 두가지 Router가 존재한다. Router01에서 문제가 발견되어 Router02를 만들었다고 한다. 그래서 이번 글에서는 Router02 contract를 다루려고한다.</p>\n<p>우선 periphery contract는 Core contract의 함수들을 보다 쉽게 사용하기위해 만들어졌다. 우리가 지금 Uniswap 웹페이지에서 사용하는 contract가 바로 periphery contract이다.</p>\n<p>이 글을 읽기 전 Core contract를 어느정도는 이해하여야 Uniswap의 전체적인 구조를 파악하는데 도움이 될 것이다.</p>\n<h2 id=\"uniswap-v2-periphery-router-주요-functions\" style=\"position:relative;\"><a href=\"#uniswap-v2-periphery-router-%EC%A3%BC%EC%9A%94-functions\" aria-label=\"uniswap v2 periphery router 주요 functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Periphery Router 주요 functions</h2>\n<p>Router02에는 26개의 function이 존재한다. 26개의 function을 모두 글로 적기에는 양이 너무 많아 가장 중요한 몇가지 함수들만 다루려고 한다.</p>\n<h3 id=\"addliquidity\" style=\"position:relative;\"><a href=\"#addliquidity\" aria-label=\"addliquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>addLiquidity</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token keyword\">function</span> <span class=\"token function\">_addLiquidity</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountADesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBDesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountAMin<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBMin\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">internal</span> virtual <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amountA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// create the pair if it doesn't exist yet</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IUniswapV2Factory</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getPair</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">IUniswapV2Factory</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createPair</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> reserveA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> reserveB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">,</span> tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reserveA <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> reserveB <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>amountADesired<span class=\"token punctuation\">,</span> amountBDesired<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">uint</span> amountBOptimal <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">quote</span><span class=\"token punctuation\">(</span>amountADesired<span class=\"token punctuation\">,</span> reserveA<span class=\"token punctuation\">,</span> reserveB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amountBOptimal <span class=\"token operator\">&lt;=</span> amountBDesired<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amountBOptimal <span class=\"token operator\">>=</span> amountBMin<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2Router: INSUFFICIENT_B_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>amountADesired<span class=\"token punctuation\">,</span> amountBOptimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">uint</span> amountAOptimal <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">quote</span><span class=\"token punctuation\">(</span>amountBDesired<span class=\"token punctuation\">,</span> reserveB<span class=\"token punctuation\">,</span> reserveA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">assert</span><span class=\"token punctuation\">(</span>amountAOptimal <span class=\"token operator\">&lt;=</span> amountADesired<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amountAOptimal <span class=\"token operator\">>=</span> amountAMin<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2Router: INSUFFICIENT_A_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>amountAOptimal<span class=\"token punctuation\">,</span> amountBDesired<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">addLiquidity</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountADesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBDesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountAMin<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBMin<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> deadline\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> virtual override <span class=\"token function\">ensure</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amountA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amountB<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">_addLiquidity</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">,</span> amountADesired<span class=\"token punctuation\">,</span> amountBDesired<span class=\"token punctuation\">,</span> amountAMin<span class=\"token punctuation\">,</span> amountBMin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">address</span> pair <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">pairFor</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">,</span> tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        TransferHelper<span class=\"token punctuation\">.</span><span class=\"token function\">safeTransferFrom</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> pair<span class=\"token punctuation\">,</span> amountA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        TransferHelper<span class=\"token punctuation\">.</span><span class=\"token function\">safeTransferFrom</span><span class=\"token punctuation\">(</span>tokenB<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> pair<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        liquidity <span class=\"token operator\">=</span> <span class=\"token function\">IUniswapV2Pair</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mint</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>addLiquidity는 <code class=\"language-text\">addLiquidity</code>와 <code class=\"language-text\">_addLiqiudity</code>로 나누어져 있다. 우선 <code class=\"language-text\">addLiquidity</code> 함수를 call 했을때 <code class=\"language-text\">_addLiquidity</code> 함수가 가장 먼저 실행되기 때문에, internal 함수인 <code class=\"language-text\">_addLiquidity</code> 함수를 살펴보자.</p>\n<p><code class=\"language-text\">_addLiquidity</code> 함수는 위에 말했듯이 Core Contract와 상호작용한다. line by line으로 한번 보도록 하자.</p>\n<ol>\n<li>처음 <code class=\"language-text\">_addLiquidity</code> 가 호출되면 pair pool이 생성되었는지 아닌지를 확인한다. 만약 pair가 없다면 factory contract의 <code class=\"language-text\">createPair</code>을 호출해 새로운 pair를 생성한다.</li>\n<li>그 후 토큰 pair의 reserve{0, 1} 값을 받아오고, 만약 reserve{0, 1} 값이 0이라면 pair가 생성되었지만 아무 token이 들어있지 않기 때문에 amount{A, B}Desired의 값을 Amount{0, 1} 값으로 지정해준다.</li>\n<li>만약 reserve{0, 1}의 값이 0이 아니라면 else문이 실행된다.</li>\n<li>else문에서는 amountBOptimal의 값 또는 amountAOptimal을 찾는다. 먼저 amountBOptimal의 값을 먼저 확인해보고 조건문에 불만족한다면 amountAOptimal를 계산해 적용한다.</li>\n</ol>\n<p>변수 중 amount{A,B}Desired이라는 값이 존재하는데, 이는 pool에 넣고싶은 각 토큰의 양을 뜻한다. amount{A,B}Desired 값을 토대로 amount{A,B}Optimal의 값을 구한다. 글고 이때 <code class=\"language-text\">UniswapV2Library</code>의 <code class=\"language-text\">quote</code> 함수를 사용한다. 이 함수는 amountADesired을 사용해 동일한 가치의 Token B(amountBOptimal의)의 값을 구한다.\n5. 만약 구한 amount{A,B}Optimal의 값이 amount{A,B}Desired보다 작다면 assert를 활용해 transaction 을 revert시킨다.\n6. 이후 amount{A,B}를 동일한 가치의 값으로 설정하여 return 한다.</p>\n<p>그후 <code class=\"language-text\">addLiquidity</code> 함수로 돌아와 나머지 code를 실행한다.</p>\n<ol>\n<li><code class=\"language-text\">address pair</code>라는 변수에 token A와 B의 Pool address를 가져온다.</li>\n<li>TansferHelper를 통해 pair contract에 각 토큰을 transfer한다.</li>\n<li>이후 제공한 liquidity만큼 LP 토큰을 mint 해준다.</li>\n</ol>\n<br>\n<h3 id=\"removeliquidity\" style=\"position:relative;\"><a href=\"#removeliquidity\" aria-label=\"removeliquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>removeLiquidity</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// **** REMOVE LIQUIDITY ****\n    function removeLiquidity(\n        address tokenA,\n        address tokenB,\n        uint liquidity,\n        uint amountAMin,\n        uint amountBMin,\n        address to,\n        uint deadline\n    ) public virtual override ensure(deadline) returns (uint amountA, uint amountB) {\n        address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);\n        IUniswapV2Pair(pair).transferFrom(msg.sender, pair, liquidity); // send liquidity to pair\n        (uint amount0, uint amount1) = IUniswapV2Pair(pair).burn(to);\n        (address token0,) = UniswapV2Library.sortTokens(tokenA, tokenB);\n        (amountA, amountB) = tokenA == token0 ? (amount0, amount1) : (amount1, amount0);\n        require(amountA >= amountAMin, 'UniswapV2Router: INSUFFICIENT_A_AMOUNT');\n        require(amountB >= amountBMin, 'UniswapV2Router: INSUFFICIENT_B_AMOUNT');\n    }</code></pre></div>\n<br>\n<p><code class=\"language-text\">removeLiquidity</code> 함수는 위에서 add 헸던 liquidity를 없앨 수 있다. line by line으로 알아보자!</p>\n<ol>\n<li>두 토큰의 pair address를 받아온다.</li>\n<li>msg.sender가 가지고 있던 lp 도큰을 pair contract에 반환한다.</li>\n<li>그리고 그 비율에 맞는 amount만큼 lp 토큰을 burn(소각)한다.\n이 함수에서 liquidity에 넣엏던 token을 반환 받는 코드가 없어 의아할 수 있지만 pair의 burn 함수에는 burn과 동시에 그 비율에 맞는 token의 msg.sender에게 송금해주는 기능이 있다.</li>\n<li>TokenA와 TokenB의 더 작은 주소 값을 token0에 할당한다.</li>\n<li>이후 tokenA와 tokenB를 정령해준다.</li>\n<li>require문을 통해 amountA와 amountB의 값이 각 토큰의 최소값보다 작은지 확인한 후 Amount{A,B}가 return된다\nrequire문을 왜 뒤에 썼나 궁금할 수도 있다. 만약 함수 안에서 require문을 통과하지 못한다면 모든 진행 과정을 초기화 한다.</li>\n</ol>\n<br>\n<!-- ### swap\n```\n// **** SWAP ****\n    // requires the initial amount to have already been sent to the first pair\n    function _swap(uint[] memory amounts, address[] memory path, address _to) internal virtual {\n        for (uint i; i < path.length - 1; i++) {\n            (address input, address output) = (path[i], path[i + 1]);\n            (address token0,) = UniswapV2Library.sortTokens(input, output);\n            uint amountOut = amounts[i + 1];\n            (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOut) : (amountOut, uint(0));\n            address to = i < path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;\n            IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(\n                amount0Out, amount1Out, to, new bytes(0)\n            );\n        }\n    }\n```\n\n<br/>\n\nperiphery contract는 너무 많은 swap관련 함수를 가지고 있기 때문에, swap에 공통적으로 쓰이는 `_swap`에 대해서 분석하도록 할 것이다.\nuniswapV2에서는 token의 pair이 존재하지 않는다면 여러개의 pair들을 걸쳐 token을 swap할 수 있게 해준다. \n1. path는 token들의 주소를 뜻하며, path를 통해 token의 주소값을 받아온다. \n2. token을 library의 sortToken 함수를 통해 정렬한다.\n3. amountOut\n -->\n<!-- ## 마무리\nRouter contract에 중요하다고 생각하는 함수를 알아보았다. 사용자가 직접 interaction 하는 부분이기 때문에 잘 알아두어야 한다고 생각한다.\n요즘은 분석보다 직접 smart contract를 구축해보는 것이 중요하다고 느낀다. Defi 이외에도 요즘 유행하는 Stepn과 같은 새로운 코드를 분석해보고 직접 운영해보고싶다 -->\n<h2 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h2>\n<ul>\n<li><a href=\"https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external\">https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external</a></li>\n<li><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps\">https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps</a></li>\n<li><a href=\"https://boohyunsik.tistory.com/9?category=922110\">https://boohyunsik.tistory.com/9?category=922110</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#uniswap-v2-periphery-router-%EC%A3%BC%EC%9A%94-functions\">Uniswap V2 Periphery Router 주요 functions</a></p>\n<ul>\n<li><a href=\"#addliquidity\">addLiquidity</a></li>\n<li><a href=\"#removeliquidity\">removeLiquidity</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#ref\">Ref</a></p>\n</li>\n</ul>\n</div>","excerpt":"👋 Uniswap V2 Periphery Router Uniswap V2 Periphery Router에는 와 , 두가지 Router가 존재한다. Router01에서 문제가 발견되어 Router02를 만들었다고 한다. 그래서 이번 글에서는 Router02 contract를 다루려고한다. 우선 periphery contract는 Core contract의 함수들을 보다 쉽게 사용하기위해 만들어졌다. 우리가 지금 Uniswap 웹페이지에서 사용하는 contract가 바로 periphery contract이다. 이 글을 읽기 전 Core contract를 어느정도는 이해하여야 Uniswap의 전체적인 구조를 파악하는데 도움이 될 것이다. Uniswap V2 Periphery Router 주요 functions Router02에는 26개의 function이 존재한다. 26개의 function을 모두 글로 적기에는 양이 너무 많아 가장 중요한 몇가지 함수들만 다루려고 한다. addLiqui…","frontmatter":{"date":"May 13, 2022","title":"Uniswap V2 Periphery Router Contract 분석","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/UniswapV2/uniswapV2PeripheryRouter/"}},"next":{"id":"5f3d9179-298f-5954-adfe-cc478885adef","html":"<h1 id=\"-twap---time-weighted-average-price\" style=\"position:relative;\"><a href=\"#-twap---time-weighted-average-price\" aria-label=\" twap   time weighted average price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 TWAP - Time Weighted Average Price</h1>\n<p>수학에 재능이 없는 나\nDefi에 들어가 있는 수식에 대한 이해를 더하기 위해 TWAP에 대해서 배우게 되었다.</p>\n<h2 id=\"twap이란\" style=\"position:relative;\"><a href=\"#twap%EC%9D%B4%EB%9E%80\" aria-label=\"twap이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Twap이란</h2>\n<p>TWAP(Time Weighted Average Price)이란 본래 미국 주식 매수 주문 종류중 하나로 시간을 동일하게 나누어 동일한 수량을 기계적으로 주문하는 방법이다. 즉 지정된 시간동안의 평균 가격인 것이다.</p>\n<p>주식에서와 다르게 uniswap은 On-Chain Oracle을 제공하기 위해 Twap을 사용하였다. 이번 글에서는 Twap에 대해서 알아보도록 할 것이고, UniswapV2가 이를 어떻게 사용하고 있는지 알아볼 것이다.</p>\n<h2 id=\"twap-예시-1\" style=\"position:relative;\"><a href=\"#twap-%EC%98%88%EC%8B%9C-1\" aria-label=\"twap 예시 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TWAP 예시 1</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 466px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABJ0AAASdAHeZh94AAAB8UlEQVQ4y4VT2XbiMAzlZWaALLYTJ85WylJoCCSFGSgcepin+f9funMk6lCWtg+KJEu60ZXljnAFpCfhOz76v/pwug68vseafLIpbvO+kw59qCgzGTbrDdbNGkVaYP48x+ufV7Yt6D1g61vdAhZZgeV8ieq5wmgwQrNosNvsMMgHN12S9hyfWV3/pGMdt+dyl1RMNlG29O91kkYGiY5vQDsWmQqpK630p7TsrGOd4Pj3H1brPYSvID1xOUMLuCgXCGX4JSDZOoihlIEKEujQXHTfUv4MkGwrLSDn+CzX+XcA9bcrQmP5aAtX3lImkEVZIRAKft+DcPwr8VpNHdo66tC3MaJMNzqfzbH9vUXdbJA9TGGyUStJPkb8rtuzdHC+7WwIk41h0uGZcvj+x6pc8MB56DKEEiEibSB9BR3GCKSGFAHHbYdRECE1OUyUnCkTKHVaTkumrHzVXkQgAh4BaekKpmcvwjZziqvLGdJ+0aXQkI02DEDJaZyyHYcxx+gsiRK2Sci2eeR3LFie5Dgejqir+jTPqkazPD0/epJ0Rm+dlv+wO+Bl+YJVvcJ+u+dG3vZvmI6nl2tDB/Q3mgf5RP1p9ITezx4/y+HDkO3H4pFjVDebzND90cVkOGEWF2vDc/Jkm3zeM8FnNm61XZuPNf8BoMWKyIJaPesAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX1\"\n        title=\"TWAP_EX1\"\n        src=\"/static/90747886e981fdc51ef69a690e01614f/fc1a1/TWAP_EX1.png\"\n        srcset=\"/static/90747886e981fdc51ef69a690e01614f/e9ff0/TWAP_EX1.png 180w,\n/static/90747886e981fdc51ef69a690e01614f/f21e7/TWAP_EX1.png 360w,\n/static/90747886e981fdc51ef69a690e01614f/fc1a1/TWAP_EX1.png 466w\"\n        sizes=\"(max-width: 466px) 100vw, 466px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진을 예로 들어보겠다. 이 사진의 Average Price는 어떻게 구할까?\n수식으로 나타내면 <code class=\"language-text\">TWAP = (100*4/6) + (200*1/6) + (100*1/6)</code> 일 것이고 <code class=\"language-text\">TWAP = 700/6 = 116.666...</code>으로 나타낼 수 있다.</p>\n<p>조금 더 복잡한 예시를 통해 수식을 만들어보자</p>\n<h2 id=\"twap-예시-2\" style=\"position:relative;\"><a href=\"#twap-%EC%98%88%EC%8B%9C-2\" aria-label=\"twap 예시 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TWAP 예시 2</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 427px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABJ0AAASdAHeZh94AAACK0lEQVQ4y22T626jQAyF6VZqk8DAXLkTEkKATdJIRN2NKq3U93+qs7IpadT2hzUemPnsczCeFBJREHHM+f06x7wP/RBiJb6dDVYBwiCERxsVKo57yE+5v/Cxb1oM+4Hz+b3wBTzPQyhCeMEywHa9RZmVXJk6uK/8mYfQ0qKqB2zbE6xJEfnhDfr46xEPDw/wCNLUDYq0YNjpcIKO9I+SrXY3JVbZqaCYzpHk56fnCVhXNbI4QyQkmj0BDXfEIApfwNoMebmDijQ/Nx/Ar/Z41NW6rJHYhKsb7WCkgbyTS1IJQJ3TGQZKc5P8DdhsGr5A3RL4Mv5Bu+sRLH2WSZ3FcQEjP4HOJJCh5sLzByMWA9tti6Htsds0DEiLBmlWQywDBuiPoK5mD9N0DWcz7pIYx98npC6FF64Ehv6E4/mK/jDCmZg9M5FCnmRwepJKsBk4Sdaw0nAhetbuX5DlG3g0Q0Q3yiESCjEBRYTYZRgvV+x2w82zew8pz7MK4+Uvuu7Id8kyj7T3bc9ezMNKq5IOkYyhVHybRwqSR7PLP4R0UDqBNilkqCYPnXF4//eOtmnR7ToM3YB1ucamqlGkOaq85H2Zl6jyiue1Kips1huOMivYe3pPhTyS8nZ949/p0B8wnkfu+Hw680pfnWbUaYeu7XAcjmwLwV/HV3Rtz/FyeJmAq8UKaZwitjGstrwWWYHEJcjTHMvnJVtAKw01nV08LfjPIHUqUpzTPZL8H8axWilz34boAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2\"\n        title=\"TWAP_EX2\"\n        src=\"/static/5567ab7ad16e48a16579296b732949d7/a7c74/TWAP_EX2.png\"\n        srcset=\"/static/5567ab7ad16e48a16579296b732949d7/e9ff0/TWAP_EX2.png 180w,\n/static/5567ab7ad16e48a16579296b732949d7/f21e7/TWAP_EX2.png 360w,\n/static/5567ab7ad16e48a16579296b732949d7/a7c74/TWAP_EX2.png 427w\"\n        sizes=\"(max-width: 427px) 100vw, 427px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>우리는 T0에서 Tn까지의 TWAP을 구하기 위해서는 다음과 같은 수식을 만들 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 371px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.666666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABJ0AAASdAHeZh94AAAAbklEQVQI102MUQqEMAxEPYHaqmhXC6UlbZMtu/c/3UiDC/vxyEDezNC4oVJFThnnceLTvoghgiJBqkDqG5e7wIURfIDbHVJIkCLa4cza6/++Myzzgh+rWfXayarsXx6FCihlmNFgs5vSPXUf/vMNRKc1bb9t6GYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-1\"\n        title=\"TWAP_EX2-1\"\n        src=\"/static/ffff431493a98893baeca56f5c1f9a0f/d4635/TWAP_EX2-1.png\"\n        srcset=\"/static/ffff431493a98893baeca56f5c1f9a0f/e9ff0/TWAP_EX2-1.png 180w,\n/static/ffff431493a98893baeca56f5c1f9a0f/f21e7/TWAP_EX2-1.png 360w,\n/static/ffff431493a98893baeca56f5c1f9a0f/d4635/TWAP_EX2-1.png 371w\"\n        sizes=\"(max-width: 371px) 100vw, 371px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n이 수식을 Sigma를 사용해 표현한다면 다음과 같은 수식을 얻을 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 147px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.70068027210885%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABJ0AAASdAHeZh94AAAB+UlEQVQoz3WSy27TQBSGDYteEtsztsfj8SVuaiVtU1rSNoCU9MYmFRVUBYkFqCAkumNXsWCBxCOwqcSa9+DhPjTjlAWCxS+P/2P/M/Od48lAEvoCLRUbVZ+9ZossSgn9EFv7n4Qv/ul5LrAbkseat4dnfJq/5mh7wvLyivvAKuiG+J3gz/tdWFsLXM1mWM8TgUCEkqWlFW7f3PDz+hvjepPaVBTKEIuIKs3p6QIlFZGISGTiQmxAmRrW8godt7fydushLyZHePfv8WrvlNurGzzP4910zvl4yropudifcTk5Zrqxy+WjE7aqdWpdOF1OTpjvPuHxcIfOqo+nRYKRCamM+fX5Ox+fvmS7P0AFEm19kVApg0kyh6WnDKlM0JEiCiSp1FQqp6dyd23Pcuh0Aso44+v5B368/8L18QW1KYnCqOXkh65x4YLn3xxDV18wdGYgqE1BkWhmzQ6ZVFzN5iiZ0F313c4Wvg1r122TrFo/IFg0zQXaEzSmYLw2ZNzbZFQNmPRHVImhnxY0WUmTVW5dqow151VO64tnY3ookeBJXxIGwnEpYk0eZRip2e4NONufslE3lDqn0gU79ZBnB4eM+gM3AfZG+Z3SzE2EJy0Pd8qWj2Vhu2V3nA0ecDo6oFCZG49a5RwOH/J874gszuiu2vlr/7tj+xt3GwcRmzphcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-2\"\n        title=\"TWAP_EX2-2\"\n        src=\"/static/a19a67f0ff9d77a6330c7b4ddbf8e270/a70ce/TWAP_EX2-2.png\"\n        srcset=\"/static/a19a67f0ff9d77a6330c7b4ddbf8e270/a70ce/TWAP_EX2-2.png 147w\"\n        sizes=\"(max-width: 147px) 100vw, 147px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>만약 T0부터 Tn까지가 아닌 Tk부터 Tn까지의 TWAP을 구하고 싶다면 다음과 같은 수식으로 변경하면 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 236px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABJ0AAASdAHeZh94AAAB+klEQVQoz3VTSW/TQBgdsTWeGe/2OLYT23ESJ7RZoSFqKkCRqICqhx5ohXrgwAFxQEhI/AQkTogDJ37tQ/O5jlAQh6f59uXNDLOlBVvasIQF13QQuQGqOIdvezBF7fsfLPmvn+lCjrQhuYkiTHA+e4LL5VMM2hm4IeBIh5pZ+8XFXvHbGKYVYUgYLQFTmPh18wU/bj7jZDQju27UJJncJN1ocUrWsj51nGM69YR6iqO0h5PhBIwxvD+9wPfrjyRfHT/HZjhDoVKcHR3j1XSNSTbEs9EC/XYXbS9E7Cq8nK6xffgI83wIxrlEqToYJQVMLvHz7Se8Xp5S13kxRhlniNwQ87zCIM7QjzMseiPEvkISKDiWTfZxp8AoyWsOdfLd+w9QqhS/333FtzcfcLnagt25Byn0mhLCEAS9UevAoHV1nqaJk09CcAlm3vLgSodW6EddbA9XqOICk2xAfJnc2vHXxDf6PlhzO7pTN4zpyYyTEuOkh001palC20Vg1dBPyxYWPNI9soWWtwPThepukibURVNfIQ0i9NsdLIoKnSBCrmJ0wzaqJMOyqFBGKTIVI1fJDlmUgEkhoaELNxzp86BloFQJXkxXeNw/hG/7iP0IHU/hYrbG+XwDw+AUX4MTiMNmwkZuoEn2LZcm17+CLpBLWrsbJDsu/8YfHS8W917pzb8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-3\"\n        title=\"TWAP_EX2-3\"\n        src=\"/static/2a5c0e78c8e68247b708952f273e9695/a7bcd/TWAP_EX2-3.png\"\n        srcset=\"/static/2a5c0e78c8e68247b708952f273e9695/e9ff0/TWAP_EX2-3.png 180w,\n/static/2a5c0e78c8e68247b708952f273e9695/a7bcd/TWAP_EX2-3.png 236w\"\n        sizes=\"(max-width: 236px) 100vw, 236px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>마지막으로 위 수식은 아래 수식으로 구할 수도 있다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 363px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABJ0AAASdAHeZh94AAABHklEQVQY03VQPU/DMBDNSuLv2HHSNk5bmhQUaCPBQhbE0AGVGSQG/gJiYeDPP3ROpwqGZ5/P7969u8QIjeN+xNLXSC8YBBPgmYBgMsYEySSMNHgZRqz84g+eBM84FFdI6Pg5fuCh22NTBeyaDn3YoC5maKsGfX2JXJpI/n5+x1N/j7VfYBda3IQWc1vGJsOyi00Srx2+Dq8YtwNymYPehbZRhOC1jUTNFT4Pb3i8vjvlHbxyoAnprzIFRCaQWGlix9vQojQFFNdRmG7NNYyY3NHfugoYVleYuwpK6ChsVQ6nJgNOWySkXlBCGDiVT7E02M6WcQU00tB00QFxyJGVOdwZqI7qE1rmObKUoaTRlYXiEoEccQmWsomTcrB/8Ausn5h73gbx2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-4\"\n        title=\"TWAP_EX2-4\"\n        src=\"/static/c2f7df7033d4e1b21269a6f7f793e1b9/4e786/TWAP_EX2-4.png\"\n        srcset=\"/static/c2f7df7033d4e1b21269a6f7f793e1b9/e9ff0/TWAP_EX2-4.png 180w,\n/static/c2f7df7033d4e1b21269a6f7f793e1b9/f21e7/TWAP_EX2-4.png 360w,\n/static/c2f7df7033d4e1b21269a6f7f793e1b9/4e786/TWAP_EX2-4.png 363w\"\n        sizes=\"(max-width: 363px) 100vw, 363px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"추가-의견\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EA%B0%80-%EC%9D%98%EA%B2%AC\" aria-label=\"추가 의견 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추가 의견</h2>\n<p>오늘 다뤘던 TWAP은 Uniswap Pair Contract에서 다뤘던 Price{0,1}Cumulative에 적용된다. 그리고 이를 사용해 Oracle을 제공한다.</p>\n<h2 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며</h2>\n<p>Defi의 중심인 수학 수식을 다뤄봤다. 아직까진 전체적인 구조에 대해 완력하게 이해하지는 못했지만, UniswapV2를 끝까지 분석해본다면 보다 완벽한 이해를 할 수 있을 것으로 보인다.</p>\n<h3 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h3>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=FNpkUNHHn7c\">https://www.youtube.com/watch?v=FNpkUNHHn7c</a></li>\n<li><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles\">https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#twap%EC%9D%B4%EB%9E%80\">Twap이란</a></p>\n</li>\n<li>\n<p><a href=\"#twap-%EC%98%88%EC%8B%9C-1\">TWAP 예시 1</a></p>\n</li>\n<li>\n<p><a href=\"#twap-%EC%98%88%EC%8B%9C-2\">TWAP 예시 2</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B6%94%EA%B0%80-%EC%9D%98%EA%B2%AC\">추가 의견</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\">마치며</a></p>\n<ul>\n<li><a href=\"#ref\">Ref</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"April 28, 2022","title":"TWAP(Time Weighted Average Price) - Defi Math","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/Defi_Math/Defi_Math_TWAP/"}},"prev":{"id":"04f8cd91-009b-553e-8f2d-18e2f5f24b8b","html":"<h1 id=\"-salt란-무엇인가\" style=\"position:relative;\"><a href=\"#-salt%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80\" aria-label=\" salt란 무엇인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Salt란 무엇인가?</h1>\n<h2 id=\"salt를-알아보는-이유\" style=\"position:relative;\"><a href=\"#salt%EB%A5%BC-%EC%95%8C%EC%95%84%EB%B3%B4%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\"salt를 알아보는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Salt를 알아보는 이유</h2>\n<p>개인적으로 Smart Contract를 분석하다보면 <code class=\"language-text\">salt</code>라는 변수를 볼때가 많았다. 내가 처음 salt를 접한 것은 <code class=\"language-text\">Uniswap Factory Contract</code>였다. 이때는 하나하나의 변수에 집중하기보다는 Uniswap의 구조와 주요 함수 및 변수를 위주로 봤기 때문에 salt라는 변수는 별생각 없이 넘겼었다. 하지만 다른 Smart Contract에서도 salt 변수를 반복적으로 사용하는 것을 확인하였고, Salt에 대해 알아볼 필요성을 느꼈다.</p>\n<hr>\n<h2 id=\"salt\" style=\"position:relative;\"><a href=\"#salt\" aria-label=\"salt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Salt</h2>\n<p>일반적으로 smart contract을 배포할때는 배포할때마다 증가하는 카운터(nonce)의 값을 사용하여 contract의 주소가 계산된다. 하지만 옵션으로 salt값을 주는 경우 카운터(nonce)를 사용하지 않고 다른 메커니즘을 사용해 contract의 주소를 계산한다.</p>\n<p>salt를 사용하여 주소를 계산하는 메커니즘은 contract의 주소를 예측할 수 있게 해준다.</p>\n<p>위키백과에는 salt를 다음과 같이 설명하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">In cryptography, a salt is random data that is used as an additional input to a one-way function that hashes data, a password or passphrase.[1]\n[full citation needed] Salts are used to safeguard passwords in storage. Historically, only a cryptographic hash function of the password was stored \non a system, but over time, additional safeguards were developed to protect against duplicate or common passwords being identifiable (as their hashes \nare identical).[2] Salting is one such protection.</code></pre></div>\n<p>해석하면 salt는 암호학에서 데이터나 암호를 해시하는 단방향 함수에 추가적으로 사용되는 임의의 데이터이다. salt는 저장소 안에 있는 암호를 보호하는데 사용된다. 과거에는 암호를 해시 함수에만 의존해 저장소에 저장했지만 시간이 지남에 따라 중복되거나 공통적인 암호에 대한 가능성이 생겼고 이를 보호하기 위한 추가 안전장치로써 salt가 개발되었다.</p>\n<p>solidity에서 salt의 예시는 두가지 경우에서 찾아볼 수 있다.</p>\n<ol>\n<li>create2</li>\n</ol>\n<p>첫번째 경우는 solidity assembly의 create2이다. CREATE2 opcode를 사용하면 contract가 배포될 주소를 예측할 수 있고, 사용자 온보딩 및 확장성을 개선할 수 있는 많은 가능성이 열립니다.(<a href=\"https://docs.openzeppelin.com/cli/2.8/deploying-with-create2\">openzeppelin</a>)</p>\n<hr>\n<h3 id=\"example-from-solidity-docs\" style=\"position:relative;\"><a href=\"#example-from-solidity-docs\" aria-label=\"example from solidity docs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example from solidity docs</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// SPDX-License-Identifier: GPL-3.0</span>\n    <span class=\"token keyword\">pragma</span> <span class=\"token keyword\">solidity</span> <span class=\"token operator\">>=</span><span class=\"token version number\">0.7.0</span> <span class=\"token operator\">&lt;</span><span class=\"token version number\">0.9.0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">contract</span> <span class=\"token class-name\">D</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> x<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> a<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            x <span class=\"token operator\">=</span> a<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">contract</span> <span class=\"token class-name\">C</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">function</span> <span class=\"token function\">createDSalted</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes32</span> salt<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> arg<span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// This complicated expression just tells you how the address</span>\n            <span class=\"token comment\">// can be pre-computed. It is just there for illustration.</span>\n            <span class=\"token comment\">// You actually only need ``new D{salt: salt}(arg)``.</span>\n            <span class=\"token builtin\">address</span> predictedAddress <span class=\"token operator\">=</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint160</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span><span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span>abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodePacked</span><span class=\"token punctuation\">(</span>\n                <span class=\"token builtin\">bytes1</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                salt<span class=\"token punctuation\">,</span>\n                <span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span>abi<span class=\"token punctuation\">.</span><span class=\"token function\">encodePacked</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token function\">type</span><span class=\"token punctuation\">(</span>D<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>creationCode<span class=\"token punctuation\">,</span>\n                    abi<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n            D d <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">D</span><span class=\"token punctuation\">{</span>salt<span class=\"token punctuation\">:</span> salt<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> predictedAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>예시를 보면 CREATE2 opcode와 salt를 사용해 주소를 예측하고, 실제로 배포함 contract와 주소를 비교하는 것을 볼 수 있다.</p>\n<ol start=\"2\">\n<li>중복 보호</li>\n</ol>\n<p><a href=\"https://www.damnvulnerabledefi.xyz/challenges/12.html\">Damn Vulnerable Defi</a> 12본 Climber에 사용된 salt이다. 여기서 salt는 Id 중복을 보호하기 위해 사용된 것으로 보인다. 아래 코드를 보면 salt 값을 넣어 hash 값을 구함으로써 중복을 방지하고 있는 것을 알 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">   <span class=\"token keyword\">function</span> <span class=\"token function\">getOperationId</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">calldata</span> targets<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint256</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">calldata</span> values<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">calldata</span> dataElements<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">bytes32</span> salt\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span>abi<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>targets<span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">,</span> dataElements<span class=\"token punctuation\">,</span> salt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h2>\n<p>openzeppelin docs: <a href=\"https://docs.openzeppelin.com/cli/2.8/deploying-with-create2\">https://docs.openzeppelin.com/cli/2.8/deploying-with-create2</a></p>\n<p>solidity docs: <a href=\"https://docs.soliditylang.org/en/v0.8.16/control-structures.html?highlight=create2#salted-contract-creations-create2\">https://docs.soliditylang.org/en/v0.8.16/control-structures.html?highlight=create2#salted-contract-creations-create2</a></p>\n<hr>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#salt%EB%A5%BC-%EC%95%8C%EC%95%84%EB%B3%B4%EB%8A%94-%EC%9D%B4%EC%9C%A0\">Salt를 알아보는 이유</a></p>\n</li>\n<li>\n<p><a href=\"#salt\">Salt</a></p>\n<ul>\n<li><a href=\"#example-from-solidity-docs\">Example from solidity docs</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#ref\">Ref</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 08, 2022","title":"Salt란 무엇인가?","categories":"solidity","author":"한성원","emoji":"🧢"},"fields":{"slug":"/S.C/salt란/"}},"site":{"siteMetadata":{"siteUrl":"https://holyhansss.github.io","comments":{"utterances":{"repo":"holyhansss/holyhansss.github.io"}}}}},"pageContext":{"slug":"/defi/UniswapV2/uniswapV2PeripheryRouter/","nextSlug":"/defi/Defi_Math/Defi_Math_TWAP/","prevSlug":"/S.C/salt란/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}