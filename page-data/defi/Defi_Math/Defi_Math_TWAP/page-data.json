{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/defi/Defi_Math/Defi_Math_TWAP/",
    "result": {"data":{"cur":{"id":"5f3d9179-298f-5954-adfe-cc478885adef","html":"<h1 id=\"-twap---time-weighted-average-price\" style=\"position:relative;\"><a href=\"#-twap---time-weighted-average-price\" aria-label=\" twap   time weighted average price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 TWAP - Time Weighted Average Price</h1>\n<p>수학에 재능이 없는 나\nDefi에 들어가 있는 수식에 대한 이해를 더하기 위해 TWAP에 대해서 배우게 되었다.</p>\n<h2 id=\"twap이란\" style=\"position:relative;\"><a href=\"#twap%EC%9D%B4%EB%9E%80\" aria-label=\"twap이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Twap이란</h2>\n<p>TWAP(Time Weighted Average Price)이란 본래 미국 주식 매수 주문 종류중 하나로 시간을 동일하게 나누어 동일한 수량을 기계적으로 주문하는 방법이다. 즉 지정된 시간동안의 평균 가격인 것이다.</p>\n<p>주식에서와 다르게 uniswap은 On-Chain Oracle을 제공하기 위해 Twap을 사용하였다. 이번 글에서는 Twap에 대해서 알아보도록 할 것이고, UniswapV2가 이를 어떻게 사용하고 있는지 알아볼 것이다.</p>\n<h2 id=\"twap-예시-1\" style=\"position:relative;\"><a href=\"#twap-%EC%98%88%EC%8B%9C-1\" aria-label=\"twap 예시 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TWAP 예시 1</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 466px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABJ0AAASdAHeZh94AAAB8UlEQVQ4y4VT2XbiMAzlZWaALLYTJ85WylJoCCSFGSgcepin+f9funMk6lCWtg+KJEu60ZXljnAFpCfhOz76v/pwug68vseafLIpbvO+kw59qCgzGTbrDdbNGkVaYP48x+ufV7Yt6D1g61vdAhZZgeV8ieq5wmgwQrNosNvsMMgHN12S9hyfWV3/pGMdt+dyl1RMNlG29O91kkYGiY5vQDsWmQqpK630p7TsrGOd4Pj3H1brPYSvID1xOUMLuCgXCGX4JSDZOoihlIEKEujQXHTfUv4MkGwrLSDn+CzX+XcA9bcrQmP5aAtX3lImkEVZIRAKft+DcPwr8VpNHdo66tC3MaJMNzqfzbH9vUXdbJA9TGGyUStJPkb8rtuzdHC+7WwIk41h0uGZcvj+x6pc8MB56DKEEiEibSB9BR3GCKSGFAHHbYdRECE1OUyUnCkTKHVaTkumrHzVXkQgAh4BaekKpmcvwjZziqvLGdJ+0aXQkI02DEDJaZyyHYcxx+gsiRK2Sci2eeR3LFie5Dgejqir+jTPqkazPD0/epJ0Rm+dlv+wO+Bl+YJVvcJ+u+dG3vZvmI6nl2tDB/Q3mgf5RP1p9ITezx4/y+HDkO3H4pFjVDebzND90cVkOGEWF2vDc/Jkm3zeM8FnNm61XZuPNf8BoMWKyIJaPesAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX1\"\n        title=\"TWAP_EX1\"\n        src=\"/static/90747886e981fdc51ef69a690e01614f/fc1a1/TWAP_EX1.png\"\n        srcset=\"/static/90747886e981fdc51ef69a690e01614f/e9ff0/TWAP_EX1.png 180w,\n/static/90747886e981fdc51ef69a690e01614f/f21e7/TWAP_EX1.png 360w,\n/static/90747886e981fdc51ef69a690e01614f/fc1a1/TWAP_EX1.png 466w\"\n        sizes=\"(max-width: 466px) 100vw, 466px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진을 예로 들어보겠다. 이 사진의 Average Price는 어떻게 구할까?\n수식으로 나타내면 <code class=\"language-text\">TWAP = (100*4/6) + (200*1/6) + (100*1/6)</code> 일 것이고 <code class=\"language-text\">TWAP = 700/6 = 116.666...</code>으로 나타낼 수 있다.</p>\n<p>조금 더 복잡한 예시를 통해 수식을 만들어보자</p>\n<h2 id=\"twap-예시-2\" style=\"position:relative;\"><a href=\"#twap-%EC%98%88%EC%8B%9C-2\" aria-label=\"twap 예시 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TWAP 예시 2</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 427px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABJ0AAASdAHeZh94AAACK0lEQVQ4y22T626jQAyF6VZqk8DAXLkTEkKATdJIRN2NKq3U93+qs7IpadT2hzUemPnsczCeFBJREHHM+f06x7wP/RBiJb6dDVYBwiCERxsVKo57yE+5v/Cxb1oM+4Hz+b3wBTzPQyhCeMEywHa9RZmVXJk6uK/8mYfQ0qKqB2zbE6xJEfnhDfr46xEPDw/wCNLUDYq0YNjpcIKO9I+SrXY3JVbZqaCYzpHk56fnCVhXNbI4QyQkmj0BDXfEIApfwNoMebmDijQ/Nx/Ar/Z41NW6rJHYhKsb7WCkgbyTS1IJQJ3TGQZKc5P8DdhsGr5A3RL4Mv5Bu+sRLH2WSZ3FcQEjP4HOJJCh5sLzByMWA9tti6Htsds0DEiLBmlWQywDBuiPoK5mD9N0DWcz7pIYx98npC6FF64Ehv6E4/mK/jDCmZg9M5FCnmRwepJKsBk4Sdaw0nAhetbuX5DlG3g0Q0Q3yiESCjEBRYTYZRgvV+x2w82zew8pz7MK4+Uvuu7Id8kyj7T3bc9ezMNKq5IOkYyhVHybRwqSR7PLP4R0UDqBNilkqCYPnXF4//eOtmnR7ToM3YB1ucamqlGkOaq85H2Zl6jyiue1Kips1huOMivYe3pPhTyS8nZ949/p0B8wnkfu+Hw680pfnWbUaYeu7XAcjmwLwV/HV3Rtz/FyeJmAq8UKaZwitjGstrwWWYHEJcjTHMvnJVtAKw01nV08LfjPIHUqUpzTPZL8H8axWilz34boAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2\"\n        title=\"TWAP_EX2\"\n        src=\"/static/5567ab7ad16e48a16579296b732949d7/a7c74/TWAP_EX2.png\"\n        srcset=\"/static/5567ab7ad16e48a16579296b732949d7/e9ff0/TWAP_EX2.png 180w,\n/static/5567ab7ad16e48a16579296b732949d7/f21e7/TWAP_EX2.png 360w,\n/static/5567ab7ad16e48a16579296b732949d7/a7c74/TWAP_EX2.png 427w\"\n        sizes=\"(max-width: 427px) 100vw, 427px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>우리는 T0에서 Tn까지의 TWAP을 구하기 위해서는 다음과 같은 수식을 만들 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 371px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.666666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABJ0AAASdAHeZh94AAAAbklEQVQI102MUQqEMAxEPYHaqmhXC6UlbZMtu/c/3UiDC/vxyEDezNC4oVJFThnnceLTvoghgiJBqkDqG5e7wIURfIDbHVJIkCLa4cza6/++Myzzgh+rWfXayarsXx6FCihlmNFgs5vSPXUf/vMNRKc1bb9t6GYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-1\"\n        title=\"TWAP_EX2-1\"\n        src=\"/static/ffff431493a98893baeca56f5c1f9a0f/d4635/TWAP_EX2-1.png\"\n        srcset=\"/static/ffff431493a98893baeca56f5c1f9a0f/e9ff0/TWAP_EX2-1.png 180w,\n/static/ffff431493a98893baeca56f5c1f9a0f/f21e7/TWAP_EX2-1.png 360w,\n/static/ffff431493a98893baeca56f5c1f9a0f/d4635/TWAP_EX2-1.png 371w\"\n        sizes=\"(max-width: 371px) 100vw, 371px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n이 수식을 Sigma를 사용해 표현한다면 다음과 같은 수식을 얻을 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 147px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.70068027210885%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABJ0AAASdAHeZh94AAAB+UlEQVQoz3WSy27TQBSGDYteEtsztsfj8SVuaiVtU1rSNoCU9MYmFRVUBYkFqCAkumNXsWCBxCOwqcSa9+DhPjTjlAWCxS+P/2P/M/Od48lAEvoCLRUbVZ+9ZossSgn9EFv7n4Qv/ul5LrAbkseat4dnfJq/5mh7wvLyivvAKuiG+J3gz/tdWFsLXM1mWM8TgUCEkqWlFW7f3PDz+hvjepPaVBTKEIuIKs3p6QIlFZGISGTiQmxAmRrW8godt7fydushLyZHePfv8WrvlNurGzzP4910zvl4yropudifcTk5Zrqxy+WjE7aqdWpdOF1OTpjvPuHxcIfOqo+nRYKRCamM+fX5Ox+fvmS7P0AFEm19kVApg0kyh6WnDKlM0JEiCiSp1FQqp6dyd23Pcuh0Aso44+v5B368/8L18QW1KYnCqOXkh65x4YLn3xxDV18wdGYgqE1BkWhmzQ6ZVFzN5iiZ0F313c4Wvg1r122TrFo/IFg0zQXaEzSmYLw2ZNzbZFQNmPRHVImhnxY0WUmTVW5dqow151VO64tnY3ookeBJXxIGwnEpYk0eZRip2e4NONufslE3lDqn0gU79ZBnB4eM+gM3AfZG+Z3SzE2EJy0Pd8qWj2Vhu2V3nA0ecDo6oFCZG49a5RwOH/J874gszuiu2vlr/7tj+xt3GwcRmzphcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-2\"\n        title=\"TWAP_EX2-2\"\n        src=\"/static/a19a67f0ff9d77a6330c7b4ddbf8e270/a70ce/TWAP_EX2-2.png\"\n        srcset=\"/static/a19a67f0ff9d77a6330c7b4ddbf8e270/a70ce/TWAP_EX2-2.png 147w\"\n        sizes=\"(max-width: 147px) 100vw, 147px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>만약 T0부터 Tn까지가 아닌 Tk부터 Tn까지의 TWAP을 구하고 싶다면 다음과 같은 수식으로 변경하면 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 236px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABJ0AAASdAHeZh94AAAB+klEQVQoz3VTSW/TQBgdsTWeGe/2OLYT23ESJ7RZoSFqKkCRqICqhx5ohXrgwAFxQEhI/AQkTogDJ37tQ/O5jlAQh6f59uXNDLOlBVvasIQF13QQuQGqOIdvezBF7fsfLPmvn+lCjrQhuYkiTHA+e4LL5VMM2hm4IeBIh5pZ+8XFXvHbGKYVYUgYLQFTmPh18wU/bj7jZDQju27UJJncJN1ocUrWsj51nGM69YR6iqO0h5PhBIwxvD+9wPfrjyRfHT/HZjhDoVKcHR3j1XSNSTbEs9EC/XYXbS9E7Cq8nK6xffgI83wIxrlEqToYJQVMLvHz7Se8Xp5S13kxRhlniNwQ87zCIM7QjzMseiPEvkISKDiWTfZxp8AoyWsOdfLd+w9QqhS/333FtzcfcLnagt25Byn0mhLCEAS9UevAoHV1nqaJk09CcAlm3vLgSodW6EddbA9XqOICk2xAfJnc2vHXxDf6PlhzO7pTN4zpyYyTEuOkh001palC20Vg1dBPyxYWPNI9soWWtwPThepukibURVNfIQ0i9NsdLIoKnSBCrmJ0wzaqJMOyqFBGKTIVI1fJDlmUgEkhoaELNxzp86BloFQJXkxXeNw/hG/7iP0IHU/hYrbG+XwDw+AUX4MTiMNmwkZuoEn2LZcm17+CLpBLWrsbJDsu/8YfHS8W917pzb8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-3\"\n        title=\"TWAP_EX2-3\"\n        src=\"/static/2a5c0e78c8e68247b708952f273e9695/a7bcd/TWAP_EX2-3.png\"\n        srcset=\"/static/2a5c0e78c8e68247b708952f273e9695/e9ff0/TWAP_EX2-3.png 180w,\n/static/2a5c0e78c8e68247b708952f273e9695/a7bcd/TWAP_EX2-3.png 236w\"\n        sizes=\"(max-width: 236px) 100vw, 236px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>마지막으로 위 수식은 아래 수식으로 구할 수도 있다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 363px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABJ0AAASdAHeZh94AAABHklEQVQY03VQPU/DMBDNSuLv2HHSNk5bmhQUaCPBQhbE0AGVGSQG/gJiYeDPP3ROpwqGZ5/P7969u8QIjeN+xNLXSC8YBBPgmYBgMsYEySSMNHgZRqz84g+eBM84FFdI6Pg5fuCh22NTBeyaDn3YoC5maKsGfX2JXJpI/n5+x1N/j7VfYBda3IQWc1vGJsOyi00Srx2+Dq8YtwNymYPehbZRhOC1jUTNFT4Pb3i8vjvlHbxyoAnprzIFRCaQWGlix9vQojQFFNdRmG7NNYyY3NHfugoYVleYuwpK6ChsVQ6nJgNOWySkXlBCGDiVT7E02M6WcQU00tB00QFxyJGVOdwZqI7qE1rmObKUoaTRlYXiEoEccQmWsomTcrB/8Ausn5h73gbx2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TWAP_EX2-4\"\n        title=\"TWAP_EX2-4\"\n        src=\"/static/c2f7df7033d4e1b21269a6f7f793e1b9/4e786/TWAP_EX2-4.png\"\n        srcset=\"/static/c2f7df7033d4e1b21269a6f7f793e1b9/e9ff0/TWAP_EX2-4.png 180w,\n/static/c2f7df7033d4e1b21269a6f7f793e1b9/f21e7/TWAP_EX2-4.png 360w,\n/static/c2f7df7033d4e1b21269a6f7f793e1b9/4e786/TWAP_EX2-4.png 363w\"\n        sizes=\"(max-width: 363px) 100vw, 363px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"추가-의견\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EA%B0%80-%EC%9D%98%EA%B2%AC\" aria-label=\"추가 의견 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추가 의견</h2>\n<p>오늘 다뤘던 TWAP은 Uniswap Pair Contract에서 다뤘던 Price{0,1}Cumulative에 적용된다. 그리고 이를 사용해 Oracle을 제공한다.</p>\n<h2 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며</h2>\n<p>Defi의 중심인 수학 수식을 다뤄봤다. 아직까진 전체적인 구조에 대해 완력하게 이해하지는 못했지만, UniswapV2를 끝까지 분석해본다면 보다 완벽한 이해를 할 수 있을 것으로 보인다.</p>\n<h3 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h3>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=FNpkUNHHn7c\">https://www.youtube.com/watch?v=FNpkUNHHn7c</a></li>\n<li><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles\">https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#twap%EC%9D%B4%EB%9E%80\">Twap이란</a></p>\n</li>\n<li>\n<p><a href=\"#twap-%EC%98%88%EC%8B%9C-1\">TWAP 예시 1</a></p>\n</li>\n<li>\n<p><a href=\"#twap-%EC%98%88%EC%8B%9C-2\">TWAP 예시 2</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B6%94%EA%B0%80-%EC%9D%98%EA%B2%AC\">추가 의견</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\">마치며</a></p>\n<ul>\n<li><a href=\"#ref\">Ref</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"👋 TWAP - Time Weighted Average Price 수학에 재능이 없는 나\nDefi에 들어가 있는 수식에 대한 이해를 더하기 위해 TWAP에 대해서 배우게 되었다. Twap이란 TWAP(Time Weighted Average Price)이란 본래 미국 주식 매수 주문 종류중 하나로 시간을 동일하게 나누어 동일한 수량을 기계적으로 주문하는 방법이다. 즉 지정된 시간동안의 평균 가격인 것이다. 주식에서와 다르게 uniswap은 On-Chain Oracle을 제공하기 위해 Twap을 사용하였다. 이번 글에서는 Twap에 대해서 알아보도록 할 것이고, UniswapV2가 이를 어떻게 사용하고 있는지 알아볼 것이다. TWAP 예시 1  위 사진을 예로 들어보겠다. 이 사진의 Average Price는 어떻게 구할까?\n수식으로 나타내면  일 것이고 으로 나타낼 수 있다. 조금 더 복잡한 예시를 통해 수식을 만들어보자 TWAP 예시 2  우리는 T0에서 Tn까지의 TWAP을 구하…","frontmatter":{"date":"April 28, 2022","title":"TWAP(Time Weighted Average Price) - Defi Math","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/Defi_Math/Defi_Math_TWAP/"}},"next":{"id":"596e2b2f-dd97-5a45-8f4f-b023a520d5f3","html":"<h1 id=\"-uniswap-v2-core-pair\" style=\"position:relative;\"><a href=\"#-uniswap-v2-core-pair\" aria-label=\" uniswap v2 core pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Uniswap V2 Core Pair</h1>\n<p>저번주에 <a href=\"https://holyhansss.github.io/defi/uniswapV2CoreFactory/\">Uniswap Factory Contract</a> 분석을 해봤다. Factory는 생각보다는 코드가 쉬웠지만 Pair은 조금 더 어려워 보인다!</p>\n<p>Pair Contact는 <a href=\"https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol\">여기서</a> 확인할 수 있고 Pair 분석 전 <a href=\"https://holyhansss.github.io/defi/uniswapV2CoreFactory/\">Factory Contract 분석</a>을 보고오면 좋을 것 같다.</p>\n<h2 id=\"uniswap-v2-pair-interface\" style=\"position:relative;\"><a href=\"#uniswap-v2-pair-interface\" aria-label=\"uniswap v2 pair interface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Pair Interface</h2>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">IUniswapV2Pair</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Approval</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> owner<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> spender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Transfer</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token keyword\">memory</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">decimals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">totalSupply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">allowance</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> spender<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">approve</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> spender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">DOMAIN_SEPARATOR</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">PERMIT_TYPEHASH</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">nonces</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">permit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> owner<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> spender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> value<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> deadline<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint8</span> v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes32</span> r<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes32</span> s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> sender<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount0In<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount1In<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount0Out<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amount1Out<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> <span class=\"token keyword\">indexed</span> to\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">event</span> <span class=\"token function\">Sync</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">MINIMUM_LIQUIDITY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">pure</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">factory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">token0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">token1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> reserve1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint32</span> blockTimestampLast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">price0CumulativeLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">price1CumulativeLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">kLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">view</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">calldata</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">skim</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>이 Interface에는 UniswapERC20 token의 interface도 포함되어 있는 것으로 보인다.\n실제 repository를 확인해 보면 UniswapERC20 token의 Interface도 따로 존재한다.\nPair contract는 Factory contract를 통해 pool 별로 배포된다. 그리고 그 안에서 swap이 일어나는 것으로 보인다.\n직접 코드를 더 봐야할 것 같지만 Uniswap이라는 이름에서 알 수 있듯이 <code class=\"language-text\">swap</code> 이라는 함수가 이 contract에서 가장 중요해 보인다. <code class=\"language-text\">swap</code>을 중심으로 Pair 코드를 뜯어보며 알아보자!</p>\n<h2 id=\"uniswap-v2-factory-코드-분석\" style=\"position:relative;\"><a href=\"#uniswap-v2-factory-%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\" aria-label=\"uniswap v2 factory 코드 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Factory 코드 분석</h2>\n<p>github에서 확인해보면 코드는 200 줄이 넘기 때문에 주석을 통해 간단한 활용성을 남기고, 중요한 함수는 코드 뒤에 따로 다루도록 할 것이다.</p>\n<h3 id=\"변수\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EC%88%98\" aria-label=\"변수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변수</h3>\n<p>우선 선언된 변수부터 살펴보자. 변수 선언부터 배울 것이 상당하다!\n<br></p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// uint에 SafeMath 적용</span>\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">SafeMath</span>  <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// uint224에 UQ112x112 적용 (UQ112는 분수 계산을 할때 쓰인다. 나중에 Library를 확인해 보자!)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">UQ112x112</span> <span class=\"token keyword\">for</span> <span class=\"token builtin\">uint224</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// liquidity의 최솟값을 10**3으로 정의</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">constant</span> MINIMUM_LIQUIDITY <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token operator\">**</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// transfer의 Method ID를 SELECTOR 변수에 설정</span>\n    <span class=\"token builtin\">bytes4</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">constant</span> SELECTOR <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes4</span><span class=\"token punctuation\">(</span><span class=\"token function\">keccak256</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transfer(address,uint256)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// factory contract의 address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> factory<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// token0의 address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> token0<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// token1의 address</span>\n    <span class=\"token builtin\">address</span> <span class=\"token keyword\">public</span> token1<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// reserve0, reserve1, blockTimestampLast가 하나의 storage slot에 선언되어있다.</span>\n    <span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve0<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n    <span class=\"token builtin\">uint112</span> <span class=\"token keyword\">private</span> reserve1<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n    <span class=\"token builtin\">uint32</span>  <span class=\"token keyword\">private</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// uses single storage slot, accessible via getReserves</span>\n\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> price0CumulativeLast<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> price1CumulativeLast<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">public</span> kLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 * reserve1, as of immediately after the most recent liquidity event</span>\n\n    <span class=\"token builtin\">uint</span> <span class=\"token keyword\">private</span> unlocked <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>너무 많은 변수가 선언되어 있기 때문에 중요하게 생각되는 부분만 설명을 할 것이다.</p>\n<ol>\n<li>우선 눈에 띄는 것은 <code class=\"language-text\">using UQ112x112 for uint224</code> 였다. library를 확인해보니 overflow를 방지 및 분수 계산을 하기 위해 만들어진 library로 보인다.</li>\n<li>두번째로 <code class=\"language-text\">reserve0</code> <code class=\"language-text\">reserve1</code> <code class=\"language-text\">blockTimestampLast</code>를 하나의 storage slot에 넣어둔 것이다.\n<ul>\n<li>여기서 reserve0와 reserve1은 uint112, blockTimestampLast는 uint32로 선언되어있다. storage는 한 slot당 256 bits(32 bytes)임으로 세 변수를 모두 하나의 slot에 넣을 수 있다. 이것은 gas를 save하기 위한 것으로 보인다.</li>\n<li>뇌피셜이지만 storage를 불러올때 gas가 사용되는데, 여러 slot에 나누어 저장하면 slot마다 gas를 더 지불해야한다. 그래서 하나의 slot에 저장해 한번에 불러올 수 있게 한 것도 gas가격을 줄이기 위한 하나의 방법인 것 같다.</li>\n</ul>\n</li>\n<li>MINIMUM_LIQUIDITY: 절대 0으로 division 되는 경우를 막기위해 최소 Liquidity를 지정했다</li>\n</ol>\n<p>나머지 변수는 주요 코드를 분석하면서 보도록하자!</p>\n<br>\n<h3 id=\"함수\" style=\"position:relative;\"><a href=\"#%ED%95%A8%EC%88%98\" aria-label=\"함수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>함수</h3>\n<p>주요 함수를 설명하면서 세부적으로 call되는 함께 설명할 예정이다.\n주요 함수는 <code class=\"language-text\">mint</code>, <code class=\"language-text\">burn</code>, <code class=\"language-text\">swap</code> 그 외 함수는 이 함수들을 위해 존재한다고 볼 수 있다.</p>\n<h4 id=\"mint\" style=\"position:relative;\"><a href=\"#mint\" aria-label=\"mint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>mint</h4>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\"><span class=\"token keyword\">function</span> <span class=\"token function\">mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// getReserves()를 통해 reserve0과 reserve1을 가져온다.</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n    <span class=\"token comment\">// contract에 있는 token의 balance를 불러온다.</span>\n    <span class=\"token builtin\">uint</span> balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// amount 값을 각 token balance - reserve 로 계산한다.</span>\n    <span class=\"token builtin\">uint</span> amount0 <span class=\"token operator\">=</span> balance0<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> amount1 <span class=\"token operator\">=</span> balance1<span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// feeOn을 통해 fee의 여부를 가져온다.</span>\n    <span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">uint</span> _totalSupply <span class=\"token operator\">=</span> totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings, must be defined here since totalSupply can update in _mintFee</span>\n    <span class=\"token comment\">// 첫번째 당시 totalSupply가 0일때 최소 totalsupply 값을 10**3으로 설정한다. -> 맨 처음 한번밖에 실행 안됨</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_totalSupply <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        liquidity <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>amount0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>MINIMUM_LIQUIDITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// lp token 10**3개 만큼 mint</span>\n       <span class=\"token function\">_mint</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MINIMUM_LIQUIDITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// permanently lock the first MINIMUM_LIQUIDITY tokens</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// min 값으로 liquidity 설정</span>\n        liquidity <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>amount0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_totalSupply<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _reserve0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_totalSupply<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// liquidity값이 0보다 큰지 확인</span>\n    <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>liquidity <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// liquidity 값 만큼 address to에 mint를 진행한다.</span>\n    <span class=\"token function\">_mint</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// reserve 값 update</span>\n    <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span>\n    <span class=\"token keyword\">emit</span> <span class=\"token function\">Mint</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>mint 함수는 LP token을 mint 해주는 함수이다. 즉, periphery contract를 통해 유동성 풀에 유동성을 공급할때 호출된다. getRerserve()를 통해 두 reserve값을 받아온다.</p>\n<p>mint에는 두가지 경우가 존재한다.</p>\n<ol>\n<li><code class=\"language-text\">totalSupply</code>가 0을때</li>\n<li><code class=\"language-text\">totalSupply</code>가 0이 아닐때</li>\n</ol>\n<p><code class=\"language-text\">totalSupply</code>가 0이라면 liquidity값을 임의로 구하고, 1000개의 토큰을 zero address에 mint한다. 우선 임의로 liquidity 값을 임의로 구하는 이유는 처음에 두 토큰의 상대적인 가치를 알지 못하기 때문이라고 docs에 써있었다.</p>\n<p>1000개의 token을 zero address에 mint하는 이유는 zero division을 막기 위해서이다. zero address가 소유하고 있다면 token을 lock할 수 있다.</p>\n<p><code class=\"language-text\">totalSupply</code>가 0이 아니라면, 즉 위 if 문이 이미 실행 되었다면 liquidity의 값을 다른 방식으로 계산한다. 이때, 우리는 토큰간의 exchange rate을 알고 있기 때문에, 유동성 제공자가 동일한 가치의 토큰을 예치할 수 있도록 한다.</p>\n<p><code class=\"language-text\">liquidity</code>의 계산 값이 0보다 크다면 <code class=\"language-text\">to</code>에게 LP 토큰을 발행한다. 이후 <code class=\"language-text\">_update()</code>을 통해 reserve0과 reserve1의 값을 업데이트한다.\n<br></p>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// update reserves and, on the first call per block, price accumulators</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> balance0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> balance1<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>balance0 <span class=\"token operator\">&lt;=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> balance1 <span class=\"token operator\">&lt;=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: OVERFLOW'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint32</span> blockTimestamp <span class=\"token operator\">=</span> <span class=\"token builtin\">uint32</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>timestamp <span class=\"token operator\">%</span> <span class=\"token number\">2</span><span class=\"token operator\">**</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint32</span> timeElapsed <span class=\"token operator\">=</span> blockTimestamp <span class=\"token operator\">-</span> blockTimestampLast<span class=\"token punctuation\">;</span> <span class=\"token comment\">// overflow is desired</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeElapsed <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> _reserve0 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> _reserve1 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// * never overflows, and + overflow is desired</span>\n            price0CumulativeLast <span class=\"token operator\">+=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>UQ112x112<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uqdiv</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> timeElapsed<span class=\"token punctuation\">;</span>\n            price1CumulativeLast <span class=\"token operator\">+=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>UQ112x112<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uqdiv</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> timeElapsed<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        reserve0 <span class=\"token operator\">=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        reserve1 <span class=\"token operator\">=</span> <span class=\"token builtin\">uint112</span><span class=\"token punctuation\">(</span>balance1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        blockTimestampLast <span class=\"token operator\">=</span> blockTimestamp<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Sync</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">,</span> reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">_update()</code>는 토큰이 deposit 되거나 withdraw 될 때 불리는 internal 함수이다. require문을 통해 balance들의 overflow를 체크한다. 그리고 <code class=\"language-text\">reserve</code>의 값들과 <code class=\"language-text\">blockTimestampLast</code>값을 새로운 값으로 update 해준다.</p>\n<p>여기서 생기는 궁금증이 있다. <code class=\"language-text\">price0CumulativeLast</code> 값은 도대체 어디에 쓰이는지 모르겠다. Defi Math를 공부하면서 TWAP(Time weighted average price)에 대해서 배웠고, <code class=\"language-text\">price0CumulativeLast</code>와 <code class=\"language-text\">price1CumulativeLast</code> 값에 적용된 것도 확인할 수 있었다. 하지만 코드에서는 <code class=\"language-text\">price0CumulativeLast</code>와 <code class=\"language-text\">price1CumulativeLast</code>를 사용하는 곳을 찾을 수 없어 의아했다. (Defi math도 다른 포스트에서 다룰 예정입니당)</p>\n<p>아마도 다른 곳에서 uniswap pair안의 토큰 가격을 Oracle로 제공하기 위해서 인것 같다. 나중에 다른 코드들을 보다면 사용성을 확인 할 수 있을 것으로 보인다. 아마 front-end에서도 사용될 수도 있을 것 같다.</p>\n<blockquote>\n<p><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles\">UniswapV2 docs</a>를 찾아보니 oracle을 위해 만들어진 것이 맞다!ㅎㅎ Defi oracle 관련해서 문제가 많았지만 UniswapV2에서 약간이나마 해결한 것으로 보인다.</p>\n</blockquote>\n<h4 id=\"burn\" style=\"position:relative;\"><a href=\"#burn\" aria-label=\"burn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>burn</h4>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token keyword\">function</span> <span class=\"token function\">burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span> to<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n        <span class=\"token builtin\">address</span> _token0 <span class=\"token operator\">=</span> token0<span class=\"token punctuation\">;</span>                                <span class=\"token comment\">// gas savings</span>\n        <span class=\"token builtin\">address</span> _token1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">;</span>                                <span class=\"token comment\">// gas savings</span>\n        <span class=\"token builtin\">uint</span> balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> liquidity <span class=\"token operator\">=</span> balanceOf<span class=\"token punctuation\">[</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">bool</span> feeOn <span class=\"token operator\">=</span> <span class=\"token function\">_mintFee</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> _totalSupply <span class=\"token operator\">=</span> totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings, must be defined here since totalSupply can update in _mintFee</span>\n        amount0 <span class=\"token operator\">=</span> liquidity<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// using balances ensures pro-rata distribution</span>\n        amount1 <span class=\"token operator\">=</span> liquidity<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance1<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> _totalSupply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// using balances ensures pro-rata distribution</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0 <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> amount1 <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">_burn</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>feeOn<span class=\"token punctuation\">)</span> kLast <span class=\"token operator\">=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// reserve0 and reserve1 are up-to-date</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Burn</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0<span class=\"token punctuation\">,</span> amount1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">burn()</code>은 liquidity를 해지(withdraw) 할때 사용되는 function이다. burn은 periphery contract을 통해 호출된다. 이때, pro-rata distribution을 사용해 address에 돌려줄 값을 구한다. (liquidity * balance / totalSupply로 계산한다.) 만약 amount의 값이 모두 0보다 크다면 amount만큼의 token을 이체한다. 이후 liquidity도 burn한다. 그리고 reserve값을 update해준다.</p>\n<p>이때 보면 <code class=\"language-text\">// gas saving</code> 이라는 주석을 많이 볼 수 있었다. 계산을 할때 storage val을 여러번 사용해야 하는데 만약 계속 storage val 사용하면 gas fee가 올라간다. 그래서 storage val을 local val에 저장해 local val을 계속해서 사용하도록 한것이다.</p>\n<h4 id=\"swap\" style=\"position:relative;\"><a href=\"#swap\" aria-label=\"swap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>swap</h4>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token comment\">// this low-level function should be called from a contract which performs important safety checks</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amount0Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amount1Out<span class=\"token punctuation\">,</span> <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bytes</span> <span class=\"token keyword\">calldata</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> lock <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0Out <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> amount1Out <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint112</span> _reserve0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint112</span> _reserve1<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// gas savings</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0Out <span class=\"token operator\">&lt;</span> _reserve0 <span class=\"token operator\">&amp;&amp;</span> amount1Out <span class=\"token operator\">&lt;</span> _reserve1<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_LIQUIDITY'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token builtin\">uint</span> balance0<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> balance1<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token comment\">// scope for _token{0,1}, avoids stack too deep errors</span>\n        <span class=\"token builtin\">address</span> _token0 <span class=\"token operator\">=</span> token0<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">address</span> _token1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>to <span class=\"token operator\">!=</span> _token0 <span class=\"token operator\">&amp;&amp;</span> to <span class=\"token operator\">!=</span> _token1<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INVALID_TO'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amount0Out <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount0Out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// optimistically transfer tokens</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amount1Out <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">_safeTransfer</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> amount1Out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// optimistically transfer tokens</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">IUniswapV2Callee</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uniswapV2Call</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0Out<span class=\"token punctuation\">,</span> amount1Out<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance0 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        balance1 <span class=\"token operator\">=</span> <span class=\"token function\">IERC20</span><span class=\"token punctuation\">(</span>_token1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token builtin\">uint</span> amount0In <span class=\"token operator\">=</span> balance0 <span class=\"token operator\">></span> _reserve0 <span class=\"token operator\">-</span> amount0Out <span class=\"token operator\">?</span> balance0 <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>_reserve0 <span class=\"token operator\">-</span> amount0Out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> amount1In <span class=\"token operator\">=</span> balance1 <span class=\"token operator\">></span> _reserve1 <span class=\"token operator\">-</span> amount1Out <span class=\"token operator\">?</span> balance1 <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>_reserve1 <span class=\"token operator\">-</span> amount1Out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amount0In <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> amount1In <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: INSUFFICIENT_INPUT_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token comment\">// scope for reserve{0,1} Adjusted, avoids stack too deep errors</span>\n        <span class=\"token builtin\">uint</span> balance0Adjusted <span class=\"token operator\">=</span> balance0<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>amount0In<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">uint</span> balance1Adjusted <span class=\"token operator\">=</span> balance1<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>amount1In<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>balance0Adjusted<span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance1Adjusted<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">(</span>_reserve0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>_reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token operator\">**</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2: K'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">_update</span><span class=\"token punctuation\">(</span>balance0<span class=\"token punctuation\">,</span> balance1<span class=\"token punctuation\">,</span> _reserve0<span class=\"token punctuation\">,</span> _reserve1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">emit</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> amount0In<span class=\"token punctuation\">,</span> amount1In<span class=\"token punctuation\">,</span> amount0Out<span class=\"token punctuation\">,</span> amount1Out<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">swap()</code>도 periphery contract를 통해 호출된다.</p>\n<ol>\n<li>output의 값이 0보다 큰지 확인한다.</li>\n<li>reserve의 값보다 amountOut의 값이 작은지 확인한다. &#x3C; 당연히 token 보유량보다 amountOut의 값이 적어야한다.</li>\n<li>to의 값이 token0, 또는 token1의 주소 값이 아닌 것을 확인한다.</li>\n<li>amountOut의 값만큼 to에게 송금한다.</li>\n<li>이후 들어온 토큰의 개수를 사용해 amountIn의 값을 계산한다.</li>\n<li>balance의 값을 다시 구한한다.</li>\n<li>adjust된 balance의 값과 reserve의 값의 값과 비교한다.</li>\n<li>reserve의 값을 update한다.</li>\n</ol>\n<p>내가 여기서 궁금했던 점은 swap은 하나의 토큰을 다른 토큰으로 교환하는 것인데, 두 token에 <code class=\"language-text\">_safeTransfer</code>을 사용하는지 였다. 궁금증을 해소하기 위해 잠시 periphery contract를 확인해 보았다. periphery contract에서 <code class=\"language-text\">swap()</code>를 call할 때는 둘중의 하나의 값이 무조껀 0이 되게 만들어 놓았다. 이 부분은 periphery contract을 살펴볼때 더 자세히 들여다보자!</p>\n<p>amountIn의 값을 구할때는 현재 token balance와 설정된 reserve값 + amountOut값을 비교해 amountIn의 값을 구한다.</p>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>나름대로 분석을 진행해봤지만 아직 부족한 점이 많은 것 같다고 느낀다. 더 많은 defi contract를 분석하다보면 전체적인 구조 및 코드가 작성된 이유를 파악하는데 도움이 될 것 같다. 그리고 이번글은 구조적으로 조금 부족한 것 같아 더 구조가 잡혀있는 글을 쓰기위해 노력 할 것이다. 다음으로는 periphery contract와 UniswapV2 Defi Math에 대해서 다룰 예정이다. Defi를 공부하는 모두 화이팅!</p>\n<h2 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h2>\n<ul>\n<li><a href=\"https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external\">https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external</a></li>\n<li><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps\">https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps</a></li>\n<li><a href=\"https://boohyunsik.tistory.com/9?category=922110\">https://boohyunsik.tistory.com/9?category=922110</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#uniswap-v2-pair-interface\">Uniswap V2 Pair Interface</a></p>\n</li>\n<li>\n<p><a href=\"#uniswap-v2-factory-%EC%BD%94%EB%93%9C-%EB%B6%84%EC%84%9D\">Uniswap V2 Factory 코드 분석</a></p>\n<ul>\n<li>\n<p><a href=\"#%EB%B3%80%EC%88%98\">변수</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%95%A8%EC%88%98\">함수</a></p>\n<ul>\n<li><a href=\"#mint\">mint</a></li>\n<li><a href=\"#burn\">burn</a></li>\n<li><a href=\"#swap\">swap</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></p>\n</li>\n<li>\n<p><a href=\"#ref\">Ref</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"April 27, 2022","title":"Uniswap V2 Core Pair Contract 분석","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/UniswapV2/uniswapV2CorePair/"}},"prev":{"id":"46407ff2-61e2-5f35-952b-fb4a6ed61162","html":"<h1 id=\"-uniswap-v2-periphery-router\" style=\"position:relative;\"><a href=\"#-uniswap-v2-periphery-router\" aria-label=\" uniswap v2 periphery router permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 Uniswap V2 Periphery Router</h1>\n<p>Uniswap V2 Periphery Router에는 <code class=\"language-text\">UniswapV2Router01.sol</code>와 <code class=\"language-text\">UniswapV2Router02.sol</code>, 두가지 Router가 존재한다. Router01에서 문제가 발견되어 Router02를 만들었다고 한다. 그래서 이번 글에서는 Router02 contract를 다루려고한다.</p>\n<p>우선 periphery contract는 Core contract의 함수들을 보다 쉽게 사용하기위해 만들어졌다. 우리가 지금 Uniswap 웹페이지에서 사용하는 contract가 바로 periphery contract이다.</p>\n<p>이 글을 읽기 전 Core contract를 어느정도는 이해하여야 Uniswap의 전체적인 구조를 파악하는데 도움이 될 것이다.</p>\n<h2 id=\"uniswap-v2-periphery-router-주요-functions\" style=\"position:relative;\"><a href=\"#uniswap-v2-periphery-router-%EC%A3%BC%EC%9A%94-functions\" aria-label=\"uniswap v2 periphery router 주요 functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uniswap V2 Periphery Router 주요 functions</h2>\n<p>Router02에는 26개의 function이 존재한다. 26개의 function을 모두 글로 적기에는 양이 너무 많아 가장 중요한 몇가지 함수들만 다루려고 한다.</p>\n<h3 id=\"addliquidity\" style=\"position:relative;\"><a href=\"#addliquidity\" aria-label=\"addliquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>addLiquidity</h3>\n<div class=\"gatsby-highlight\" data-language=\"solidity\"><pre class=\"language-solidity\"><code class=\"language-solidity\">    <span class=\"token keyword\">function</span> <span class=\"token function\">_addLiquidity</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountADesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBDesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountAMin<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBMin\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">internal</span> virtual <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amountA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// create the pair if it doesn't exist yet</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IUniswapV2Factory</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getPair</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">IUniswapV2Factory</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createPair</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> reserveA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> reserveB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">getReserves</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">,</span> tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reserveA <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> reserveB <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>amountADesired<span class=\"token punctuation\">,</span> amountBDesired<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">uint</span> amountBOptimal <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">quote</span><span class=\"token punctuation\">(</span>amountADesired<span class=\"token punctuation\">,</span> reserveA<span class=\"token punctuation\">,</span> reserveB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>amountBOptimal <span class=\"token operator\">&lt;=</span> amountBDesired<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amountBOptimal <span class=\"token operator\">>=</span> amountBMin<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2Router: INSUFFICIENT_B_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>amountADesired<span class=\"token punctuation\">,</span> amountBOptimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">uint</span> amountAOptimal <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">quote</span><span class=\"token punctuation\">(</span>amountBDesired<span class=\"token punctuation\">,</span> reserveB<span class=\"token punctuation\">,</span> reserveA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">assert</span><span class=\"token punctuation\">(</span>amountAOptimal <span class=\"token operator\">&lt;=</span> amountADesired<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>amountAOptimal <span class=\"token operator\">>=</span> amountAMin<span class=\"token punctuation\">,</span> <span class=\"token string\">'UniswapV2Router: INSUFFICIENT_A_AMOUNT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>amountAOptimal<span class=\"token punctuation\">,</span> amountBDesired<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">addLiquidity</span><span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">address</span> tokenA<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> tokenB<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountADesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBDesired<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountAMin<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> amountBMin<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">address</span> to<span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">uint</span> deadline\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">external</span> virtual override <span class=\"token function\">ensure</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">uint</span> amountA<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> amountB<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uint</span> liquidity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span>amountA<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">_addLiquidity</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">,</span> amountADesired<span class=\"token punctuation\">,</span> amountBDesired<span class=\"token punctuation\">,</span> amountAMin<span class=\"token punctuation\">,</span> amountBMin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">address</span> pair <span class=\"token operator\">=</span> UniswapV2Library<span class=\"token punctuation\">.</span><span class=\"token function\">pairFor</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">,</span> tokenA<span class=\"token punctuation\">,</span> tokenB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        TransferHelper<span class=\"token punctuation\">.</span><span class=\"token function\">safeTransferFrom</span><span class=\"token punctuation\">(</span>tokenA<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> pair<span class=\"token punctuation\">,</span> amountA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        TransferHelper<span class=\"token punctuation\">.</span><span class=\"token function\">safeTransferFrom</span><span class=\"token punctuation\">(</span>tokenB<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">,</span> pair<span class=\"token punctuation\">,</span> amountB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        liquidity <span class=\"token operator\">=</span> <span class=\"token function\">IUniswapV2Pair</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mint</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>addLiquidity는 <code class=\"language-text\">addLiquidity</code>와 <code class=\"language-text\">_addLiqiudity</code>로 나누어져 있다. 우선 <code class=\"language-text\">addLiquidity</code> 함수를 call 했을때 <code class=\"language-text\">_addLiquidity</code> 함수가 가장 먼저 실행되기 때문에, internal 함수인 <code class=\"language-text\">_addLiquidity</code> 함수를 살펴보자.</p>\n<p><code class=\"language-text\">_addLiquidity</code> 함수는 위에 말했듯이 Core Contract와 상호작용한다. line by line으로 한번 보도록 하자.</p>\n<ol>\n<li>처음 <code class=\"language-text\">_addLiquidity</code> 가 호출되면 pair pool이 생성되었는지 아닌지를 확인한다. 만약 pair가 없다면 factory contract의 <code class=\"language-text\">createPair</code>을 호출해 새로운 pair를 생성한다.</li>\n<li>그 후 토큰 pair의 reserve{0, 1} 값을 받아오고, 만약 reserve{0, 1} 값이 0이라면 pair가 생성되었지만 아무 token이 들어있지 않기 때문에 amount{A, B}Desired의 값을 Amount{0, 1} 값으로 지정해준다.</li>\n<li>만약 reserve{0, 1}의 값이 0이 아니라면 else문이 실행된다.</li>\n<li>else문에서는 amountBOptimal의 값 또는 amountAOptimal을 찾는다. 먼저 amountBOptimal의 값을 먼저 확인해보고 조건문에 불만족한다면 amountAOptimal를 계산해 적용한다.</li>\n</ol>\n<p>변수 중 amount{A,B}Desired이라는 값이 존재하는데, 이는 pool에 넣고싶은 각 토큰의 양을 뜻한다. amount{A,B}Desired 값을 토대로 amount{A,B}Optimal의 값을 구한다. 글고 이때 <code class=\"language-text\">UniswapV2Library</code>의 <code class=\"language-text\">quote</code> 함수를 사용한다. 이 함수는 amountADesired을 사용해 동일한 가치의 Token B(amountBOptimal의)의 값을 구한다.\n5. 만약 구한 amount{A,B}Optimal의 값이 amount{A,B}Desired보다 작다면 assert를 활용해 transaction 을 revert시킨다.\n6. 이후 amount{A,B}를 동일한 가치의 값으로 설정하여 return 한다.</p>\n<p>그후 <code class=\"language-text\">addLiquidity</code> 함수로 돌아와 나머지 code를 실행한다.</p>\n<ol>\n<li><code class=\"language-text\">address pair</code>라는 변수에 token A와 B의 Pool address를 가져온다.</li>\n<li>TansferHelper를 통해 pair contract에 각 토큰을 transfer한다.</li>\n<li>이후 제공한 liquidity만큼 LP 토큰을 mint 해준다.</li>\n</ol>\n<br>\n<h3 id=\"removeliquidity\" style=\"position:relative;\"><a href=\"#removeliquidity\" aria-label=\"removeliquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>removeLiquidity</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// **** REMOVE LIQUIDITY ****\n    function removeLiquidity(\n        address tokenA,\n        address tokenB,\n        uint liquidity,\n        uint amountAMin,\n        uint amountBMin,\n        address to,\n        uint deadline\n    ) public virtual override ensure(deadline) returns (uint amountA, uint amountB) {\n        address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);\n        IUniswapV2Pair(pair).transferFrom(msg.sender, pair, liquidity); // send liquidity to pair\n        (uint amount0, uint amount1) = IUniswapV2Pair(pair).burn(to);\n        (address token0,) = UniswapV2Library.sortTokens(tokenA, tokenB);\n        (amountA, amountB) = tokenA == token0 ? (amount0, amount1) : (amount1, amount0);\n        require(amountA >= amountAMin, 'UniswapV2Router: INSUFFICIENT_A_AMOUNT');\n        require(amountB >= amountBMin, 'UniswapV2Router: INSUFFICIENT_B_AMOUNT');\n    }</code></pre></div>\n<br>\n<p><code class=\"language-text\">removeLiquidity</code> 함수는 위에서 add 헸던 liquidity를 없앨 수 있다. line by line으로 알아보자!</p>\n<ol>\n<li>두 토큰의 pair address를 받아온다.</li>\n<li>msg.sender가 가지고 있던 lp 도큰을 pair contract에 반환한다.</li>\n<li>그리고 그 비율에 맞는 amount만큼 lp 토큰을 burn(소각)한다.\n이 함수에서 liquidity에 넣엏던 token을 반환 받는 코드가 없어 의아할 수 있지만 pair의 burn 함수에는 burn과 동시에 그 비율에 맞는 token의 msg.sender에게 송금해주는 기능이 있다.</li>\n<li>TokenA와 TokenB의 더 작은 주소 값을 token0에 할당한다.</li>\n<li>이후 tokenA와 tokenB를 정령해준다.</li>\n<li>require문을 통해 amountA와 amountB의 값이 각 토큰의 최소값보다 작은지 확인한 후 Amount{A,B}가 return된다\nrequire문을 왜 뒤에 썼나 궁금할 수도 있다. 만약 함수 안에서 require문을 통과하지 못한다면 모든 진행 과정을 초기화 한다.</li>\n</ol>\n<br>\n<!-- ### swap\n```\n// **** SWAP ****\n    // requires the initial amount to have already been sent to the first pair\n    function _swap(uint[] memory amounts, address[] memory path, address _to) internal virtual {\n        for (uint i; i < path.length - 1; i++) {\n            (address input, address output) = (path[i], path[i + 1]);\n            (address token0,) = UniswapV2Library.sortTokens(input, output);\n            uint amountOut = amounts[i + 1];\n            (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOut) : (amountOut, uint(0));\n            address to = i < path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;\n            IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(\n                amount0Out, amount1Out, to, new bytes(0)\n            );\n        }\n    }\n```\n\n<br/>\n\nperiphery contract는 너무 많은 swap관련 함수를 가지고 있기 때문에, swap에 공통적으로 쓰이는 `_swap`에 대해서 분석하도록 할 것이다.\nuniswapV2에서는 token의 pair이 존재하지 않는다면 여러개의 pair들을 걸쳐 token을 swap할 수 있게 해준다. \n1. path는 token들의 주소를 뜻하며, path를 통해 token의 주소값을 받아온다. \n2. token을 library의 sortToken 함수를 통해 정렬한다.\n3. amountOut\n -->\n<!-- ## 마무리\nRouter contract에 중요하다고 생각하는 함수를 알아보았다. 사용자가 직접 interaction 하는 부분이기 때문에 잘 알아두어야 한다고 생각한다.\n요즘은 분석보다 직접 smart contract를 구축해보는 것이 중요하다고 느낀다. Defi 이외에도 요즘 유행하는 Stepn과 같은 새로운 코드를 분석해보고 직접 운영해보고싶다 -->\n<h2 id=\"ref\" style=\"position:relative;\"><a href=\"#ref\" aria-label=\"ref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ref</h2>\n<ul>\n<li><a href=\"https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external\">https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#pair-external</a></li>\n<li><a href=\"https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps\">https://docs.uniswap.org/protocol/V2/concepts/core-concepts/swaps</a></li>\n<li><a href=\"https://boohyunsik.tistory.com/9?category=922110\">https://boohyunsik.tistory.com/9?category=922110</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#uniswap-v2-periphery-router-%EC%A3%BC%EC%9A%94-functions\">Uniswap V2 Periphery Router 주요 functions</a></p>\n<ul>\n<li><a href=\"#addliquidity\">addLiquidity</a></li>\n<li><a href=\"#removeliquidity\">removeLiquidity</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#ref\">Ref</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"May 13, 2022","title":"Uniswap V2 Periphery Router Contract 분석","categories":"Defi","author":"한성원","emoji":"🧢"},"fields":{"slug":"/defi/UniswapV2/uniswapV2PeripheryRouter/"}},"site":{"siteMetadata":{"siteUrl":"https://holyhansss.github.io","comments":{"utterances":{"repo":""}}}}},"pageContext":{"slug":"/defi/Defi_Math/Defi_Math_TWAP/","nextSlug":"/defi/UniswapV2/uniswapV2CorePair/","prevSlug":"/defi/UniswapV2/uniswapV2PeripheryRouter/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}