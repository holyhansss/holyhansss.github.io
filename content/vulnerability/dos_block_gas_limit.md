---
emoji: 🧢
title: (취약점 시리즈 7) DOS With Block Gas Limit
date: '2021-12-31 19:47:00'
author: 한성원
tags: DOS Block Gas Limit BlockGasLimit 취약점 SmartContract DenialofService
categories: 취약점분석
---


# 👋 DoS(Denial of Service) With Block Gas Limit

## 들어가기전
### GAS란 무엇인가?
이더리움 블록체인의 블록들은 각 블록마다 소비 할 수 있는 가스의 최대량이 정해져있다. 즉 각 블록이 소비할 수 있는 최대량을 넘어선다면 __transaction들은 fail__ 하게된다.

- - -

### DoS With Block Gas Limit
연산당 Gas가 정해져 있으며 smart contract를 실행할 때 계산된다. Block Gas Limit DOS은 smart contract가 실행되고 Gas를 계산할때 최대 연산량을 초과하면 발생한다. 
예를 들어보겠다.
1. 한 smart contract에 사용자가 많아짐에 따라 크기가 증가하는 Array가 있다.
2. smart contract안에는 그 array 전체를 순환하는 작업이 있다.
3. 처음에는 괜찮았으나 시간이 지날수록 Array가 커져 연상량이 증가한다.
4. 연산량이 너무 많아져 Denial Of Service로 이어질 수 있다. 

보다 잘 이해하기 위해 Example Code를 살펴보자!!
- - -

## Example code
간단한 code로 이해해보자!
```solidity
struct Payee {
    address addr;
    uint256 value;
}

Payee[] payees;
uint256 nextPayeeIndex;
function pay() {
  //pay something
}
function payOut() {
    uint256 i = nextPayeeIndex;
    while (i < payees.length && msg.gas > 200000) {
      payees[i].addr.send(payees[i].value);
      i++;
    }
    nextPayeeIndex = i;
}
```
이 contract는 Payee들에게 순차적으로 환불해주는 function을 포함하고 있다.
시나리오는 이렇다.
1. pay()를  통해 payees Array에 address와 value를 추가한다.
2. 점점 payees[]의 크기가 늘어난다.
3. payOut()을 실행할때가 되어 실행시킨다.
4. payOut()은 payees[] 전체를 순환하며 value를 지급한다.
5. payOut()에서 while문을 실행시키다 block gas limit를 초과한다.
6. 결국 payOut()를 실행 할 수 없어, ETH가 lock된다.

- - -
## Another Exmample
위 Example Code는 smart contract를 만들때 개발자의 실수로 일어날 수 있다.
하지만 개발자의 실수가 아니더라도 공격자는 높은 가스 가격으로 transaction을 일으킴으로써 transaction이 블록체인에 포함되는 것을 막을 수 있다. 

이 공격은 도박 Dapp인 Fomo3D에서 발생했었다. Fomo3D는 특정 조건에서 키를 발급해주고 마지막으로 Key를 받은 사람에게 보상을 주는 시스템이다. 보상은 타이머가 끝나는 시점에 주어지게되고 Key를 새로 받을 때마다 타이머의 시간이 늘어난다.

Fomo3D에서는 __Block Stuffing__ 을 통해서 ether를 가로챘다. BLock Stuffing을 블록을 채운다는 뜻으로 블록을 채워 Gas Limit을 넘게 만들고 이로인해 transaction이 블록에 기록되지 못하게 하는 것이다. 

시나리오는 이렇다.
1. attacker가 특정 조건을 만족시켜 __키를__ 발급받는다. 
2. 이후 타이머가 끝날때까지 block stuffing을 통해 다른 transaction을 기록하지 못하게 한다.
3. 타이머가 끝나는 시간에 보상을 받는다.

아마 block을 채우는데 많은 돈이 들지만 그만큼 보상이 확실하다면 attack을 받을 여지가 있다.

- - -

## How to prevent?
시간이 지남에 따라 크기가 증가하는 array는 사용에 주의해야한다. 또한 그 array를 순환하는 반복문 작업도 피해야한다.
또한 꼭 처리해야하는 경우에는 DOS unexpected revert에서 알아보았던 pull over push 방법을 사용해 transaction을 처리해야한다.
- pull over push: contract를 분리함으로써 attacker의 공격을 attacker의 손실로만 처리 할 수 있다. 위의 코드를 pull over push로 바꾸어보았다.

- - -

## 마무리
DOS는 EVM과 큰 관련이 있는 취약점 같다. EVM의 가스체계를 공부함으로써 GAS Optimization등에 대해 깊게 배울 수 있을 것 같다! 취약점 이후에는 EVM에 대한 연구를 해본다면 더 성장할 수 있을 것 같다. 끝!!!
- - -

### Reference
- https://swcregistry.io/docs/SWC-128
- https://consensys.github.io/smart-contract-best-practices/known_attacks/#gas-limit-dos-on-a-contract-via-unbounded-operations


```toc

```